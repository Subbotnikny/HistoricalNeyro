# app_with_ngrok.py - –í–µ—Ä—Å–∏—è —Å –≤–∏–¥–µ–æ-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
# ========== SSL –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
import ssl
import certifi
import urllib.request

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è Python
ssl._create_default_https_context = ssl.create_default_context
ssl.create_default_context().load_verify_locations(certifi.where())

# –î–ª—è urllib
urllib.request.ssl.create_default_context = lambda: ssl.create_default_context(cafile=certifi.where())

from flask import Flask, render_template_string, request, jsonify, session, send_from_directory
from datetime import datetime
import asyncio
import g4f
import json
import sqlite3
import hashlib
import random
import time
import threading
import subprocess
import sys
import os
import re
import glob
from pyngrok import ngrok, conf
import edge_tts
from functools import lru_cache
from threading import Lock
try:
    from gtts import gTTS
    GTTS_AVAILABLE = True
except ImportError:
    GTTS_AVAILABLE = False

# Coqui TTS —Ç—Ä–µ–±—É–µ—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä C++, –ø–æ—ç—Ç–æ–º—É –æ—Ç–∫–ª—é—á–µ–Ω
# –ï—Å–ª–∏ –Ω—É–∂–µ–Ω fallback, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ TTS —Å–µ—Ä–≤–∏—Å—ã
COQUI_TTS_AVAILABLE = False

app = Flask(__name__)
app.config['SECRET_KEY'] = 'historical-chat-secret-key-2024'

# ========== –ü–ï–†–ï–í–û–î–´ ==========
TRANSLATIONS = {
    'ru': {
        'title': '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ß–∞—Ç-–±–æ—Ç',
        'subtitle': '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 30 —Å–ª—É—á–∞–π–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π | –ü—Ä–µ–º–∏—É–º: –õ—é–±–∞—è –ª–∏—á–Ω–æ—Å—Ç—å –∑–∞ 1000 —Ç–µ–Ω–≥–µ',
        'balance': '–ë–∞–ª–∞–Ω—Å',
        'currency': '—Ç–µ–Ω–≥–µ',
        'premium': '–ü–†–ï–ú–ò–£–ú',
        'donate': '–î–æ–Ω–∞—Ç',
        'free_personalities': '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏',
        'create_your_own': '–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é',
        'create_personality': '–°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å',
        'personality_name_placeholder': '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–∏—á–Ω–æ—Å—Ç–∏',
        'refresh': '–û–±–Ω–æ–≤–∏—Ç—å',
        'clear': '–û—á–∏—Å—Ç–∏—Ç—å',
        'welcome_message': '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –ª–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞.',
        'select_personality_placeholder': '–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞...',
        'ask_placeholder': '–°–ø—Ä–æ—Å–∏—Ç–µ —É {name}...',
        'send': '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        'voice_input': '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥',
        'top_up_balance': '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å',
        'current_balance': '–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å',
        'premium_access': '–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø',
        'premium_description': '–í–≤–æ–¥–∏—Ç–µ –ª—é–±—É—é –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –ª–∏—á–Ω–æ—Å—Ç—å',
        'cost': '–°—Ç–æ–∏–º–æ—Å—Ç—å',
        'unlock': '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',
        'greeting': '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –Ø {name}. –û —á—ë–º —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?',
        'bot_name': '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –±–æ—Ç',
        'waiting': '–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞',
        'balance_added': '–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount} —Ç–µ–Ω–≥–µ',
        'premium_unlocked': '–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!',
        'language': '–Ø–∑—ã–∫'
    },
    'en': {
        'title': 'Historical Chat-bot',
        'subtitle': 'Free: 30 random personalities | Premium: Any personality for 1000 tenge',
        'balance': 'Balance',
        'currency': 'tenge',
        'premium': 'PREMIUM',
        'donate': 'Donate',
        'free_personalities': 'Free Personalities',
        'create_your_own': 'Create Your Own',
        'create_personality': 'Create Personality',
        'personality_name_placeholder': 'Enter personality name',
        'refresh': 'Refresh',
        'clear': 'Clear',
        'welcome_message': 'Welcome! Select a historical personality to start a dialogue.',
        'select_personality_placeholder': 'Select a personality to start chat...',
        'ask_placeholder': 'Ask {name}...',
        'send': 'Send',
        'voice_input': 'Voice Input',
        'top_up_balance': 'Top Up Balance',
        'current_balance': 'Current Balance',
        'premium_access': 'Premium Access',
        'premium_description': 'Enter any historical personality',
        'cost': 'Cost',
        'unlock': 'Unlock',
        'greeting': 'Greetings! I am {name}. What would you like to talk about?',
        'bot_name': 'Historical Bot',
        'waiting': 'Waiting for response',
        'balance_added': 'Balance topped up by {amount} tenge',
        'premium_unlocked': 'Premium access unlocked!',
        'language': 'Language'
    },
    'kk': {
        'title': '–¢–∞—Ä–∏—Ö–∏ –ß–∞—Ç-–±–æ—Ç',
        'subtitle': '–¢–µ–≥—ñ–Ω: 30 –∫–µ–∑–¥–µ–π—Å–æ“õ —Ç“±–ª“ì–∞ | –ü—Ä–µ–º–∏—É–º: –ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Ç“±–ª“ì–∞ 1000 —Ç–µ“£–≥–µ',
        'balance': '–ë–∞–ª–∞–Ω—Å',
        'currency': '—Ç–µ“£–≥–µ',
        'premium': '–ü–†–ï–ú–ò–£–ú',
        'donate': '–î–æ–Ω–∞—Ç',
        'free_personalities': '–¢–µ–≥—ñ–Ω —Ç“±–ª“ì–∞–ª–∞—Ä',
        'create_your_own': '”®–∑ —Ç“±–ª“ì–∞“£—ã–∑–¥—ã –∂–∞—Å–∞“£—ã–∑',
        'create_personality': '–¢“±–ª“ì–∞ –∂–∞—Å–∞—É',
        'personality_name_placeholder': '–¢“±–ª“ì–∞ –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
        'refresh': '–ñ–∞“£–∞—Ä—Ç—É',
        'clear': '–¢–∞–∑–∞–ª–∞—É',
        'welcome_message': '“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑! –î–∏–∞–ª–æ–≥—Ç—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω —Ç–∞—Ä–∏—Ö–∏ —Ç“±–ª“ì–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑.',
        'select_personality_placeholder': '–ß–∞—Ç—Ç—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω —Ç“±–ª“ì–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑...',
        'ask_placeholder': '{name} —Å“±—Ä–∞“£—ã–∑...',
        'send': '–ñ—ñ–±–µ—Ä—É',
        'voice_input': '–î–∞—É—ã—Å—Ç—ã“õ –µ–Ω–≥—ñ–∑—É',
        'top_up_balance': '–ë–∞–ª–∞–Ω—Å—Ç—ã —Ç–æ–ª—Ç—ã—Ä—É',
        'current_balance': '–ê“ì—ã–º–¥–∞“ì—ã –±–∞–ª–∞–Ω—Å',
        'premium_access': '–ü—Ä–µ–º–∏—É–º “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ–ª—ñ–≥—ñ',
        'premium_description': '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Ç–∞—Ä–∏—Ö–∏ —Ç“±–ª“ì–∞–Ω—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
        'cost': '–ë–∞“ì–∞—Å—ã',
        'unlock': '–ê—à—É',
        'greeting': '–°”ô–ª–µ–º! –ú–µ–Ω {name}. –ù–µ —Ç—É—Ä–∞–ª—ã —Å”©–π–ª–µ—Å–µ–π—ñ–∫?',
        'bot_name': '–¢–∞—Ä–∏—Ö–∏ –±–æ—Ç',
        'waiting': '–ñ–∞—É–∞–ø –∫“Ø—Ç—É',
        'balance_added': '–ë–∞–ª–∞–Ω—Å {amount} —Ç–µ“£–≥–µ–≥–µ —Ç–æ–ª—Ç—ã—Ä—ã–ª–¥—ã',
        'premium_unlocked': '–ü—Ä–µ–º–∏—É–º “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ–ª—ñ–≥—ñ –∞—à—ã–ª–¥—ã!',
        'language': '–¢—ñ–ª'
    }
}

def get_translation(key, lang='ru', **kwargs):
    """–ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ –ø–æ –∫–ª—é—á—É"""
    if lang not in TRANSLATIONS:
        lang = 'ru'
    translation = TRANSLATIONS[lang].get(key, TRANSLATIONS['ru'].get(key, key))
    if kwargs:
        return translation.format(**kwargs)
    return translation

def get_lang():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫ –∏–∑ —Å–µ—Å—Å–∏–∏"""
    return session.get('language', 'ru')

# ========== –ü–ï–†–ï–í–û–î–´ –†–û–õ–ï–ô –ò –≠–ü–û–• ==========
ROLE_TRANSLATIONS = {
    'ru': {
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π': '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π',
        '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞ –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∞—è': '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞ –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∞—è',
        '–§–∏–∑–∏–∫-—Ç–µ–æ—Ä–µ—Ç–∏–∫': '–§–∏–∑–∏–∫-—Ç–µ–æ—Ä–µ—Ç–∏–∫',
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –§—Ä–∞–Ω—Ü–∏–∏': '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –§—Ä–∞–Ω—Ü–∏–∏',
        '–•—É–¥–æ–∂–Ω–∏–∫ –∏ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å': '–•—É–¥–æ–∂–Ω–∏–∫ –∏ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å',
        '–†–∏–º—Å–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü': '–†–∏–º—Å–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü',
        '–§–∏–ª–æ—Å–æ—Ñ': '–§–∏–ª–æ—Å–æ—Ñ',
        '–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å': '–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å',
        '–ü–∏—Å–∞—Ç–µ–ª—å': '–ü–∏—Å–∞—Ç–µ–ª—å',
        '–¶–∞—Ä—å –ú–∞–∫–µ–¥–æ–Ω–∏–∏': '–¶–∞—Ä—å –ú–∞–∫–µ–¥–æ–Ω–∏–∏',
        '–¶–∞—Ä–∏—Ü–∞ –ï–≥–∏–ø—Ç–∞': '–¶–∞—Ä–∏—Ü–∞ –ï–≥–∏–ø—Ç–∞',
        '–ö–æ—Ä–æ–ª—å —Ñ—Ä–∞–Ω–∫–æ–≤': '–ö–æ—Ä–æ–ª—å —Ñ—Ä–∞–Ω–∫–æ–≤',
        '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –ú–æ–Ω–≥–æ–ª—å—Å–∫–æ–π –∏–º–ø–µ—Ä–∏–∏': '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –ú–æ–Ω–≥–æ–ª—å—Å–∫–æ–π –∏–º–ø–µ—Ä–∏–∏',
        '–°–∫—É–ª—å–ø—Ç–æ—Ä –∏ —Ö—É–¥–æ–∂–Ω–∏–∫': '–°–∫—É–ª—å–ø—Ç–æ—Ä –∏ —Ö—É–¥–æ–∂–Ω–∏–∫',
        '–ü–æ—ç—Ç –∏ –¥—Ä–∞–º–∞—Ç—É—Ä–≥': '–ü–æ—ç—Ç –∏ –¥—Ä–∞–º–∞—Ç—É—Ä–≥',
        '–ê—Å—Ç—Ä–æ–Ω–æ–º –∏ —Ñ–∏–∑–∏–∫': '–ê—Å—Ç—Ä–æ–Ω–æ–º –∏ —Ñ–∏–∑–∏–∫',
        '–ö–æ—Ä–æ–ª–µ–≤–∞ –ê–Ω–≥–ª–∏–∏': '–ö–æ—Ä–æ–ª–µ–≤–∞ –ê–Ω–≥–ª–∏–∏',
        '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –°–®–ê': '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –°–®–ê',
        '–ü—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏': '–ü—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏',
        '–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫': '–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫',
        '–ö–æ—Ä–æ–ª—å –§—Ä–∞–Ω—Ü–∏–∏': '–ö–æ—Ä–æ–ª—å –§—Ä–∞–Ω—Ü–∏–∏',
        '–¶–∞—Ä—å –≤—Å–µ—è –†—É—Å–∏': '–¶–∞—Ä—å –≤—Å–µ—è –†—É—Å–∏',
        '–í–µ–ª–∏–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü': '–í–µ–ª–∏–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü',
        '–£—á—ë–Ω—ã–π –∏ –ø–æ—ç—Ç': '–£—á—ë–Ω—ã–π –∏ –ø–æ—ç—Ç',
        '–ö–æ—Ä–æ–ª—å –ê–Ω–≥–ª–∏–∏': '–ö–æ—Ä–æ–ª—å –ê–Ω–≥–ª–∏–∏',
        '–ê—Å—Ç—Ä–æ–Ω–æ–º': '–ê—Å—Ç—Ä–æ–Ω–æ–º',
        '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å': '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å',
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ò–ò
        '–ü–æ–ª–∫–æ–≤–æ–¥–µ—Ü': '–ü–æ–ª–∫–æ–≤–æ–¥–µ—Ü',
        '–í–æ–µ–Ω–∞—á–∞–ª—å–Ω–∏–∫': '–í–æ–µ–Ω–∞—á–∞–ª—å–Ω–∏–∫',
        '–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—è—Ç–µ–ª—å': '–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—è—Ç–µ–ª—å',
        '–ü—Ä–∞–≤–∏—Ç–µ–ª—å': '–ü—Ä–∞–≤–∏—Ç–µ–ª—å',
        '–ú–æ–Ω–∞—Ä—Ö': '–ú–æ–Ω–∞—Ä—Ö',
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä': '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä',
        '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞': '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞',
        '–¶–∞—Ä—å': '–¶–∞—Ä—å',
        '–¶–∞—Ä–∏—Ü–∞': '–¶–∞—Ä–∏—Ü–∞',
        '–ö–æ—Ä–æ–ª—å': '–ö–æ—Ä–æ–ª—å',
        '–ö–æ—Ä–æ–ª–µ–≤–∞': '–ö–æ—Ä–æ–ª–µ–≤–∞',
        '–ö–Ω—è–∑—å': '–ö–Ω—è–∑—å',
        '–ö–Ω—è–≥–∏–Ω—è': '–ö–Ω—è–≥–∏–Ω—è',
        '–£—á–µ–Ω—ã–π': '–£—á–µ–Ω—ã–π',
        '–ú–∞—Ç–µ–º–∞—Ç–∏–∫': '–ú–∞—Ç–µ–º–∞—Ç–∏–∫',
        '–§–∏–∑–∏–∫': '–§–∏–∑–∏–∫',
        '–•–∏–º–∏–∫': '–•–∏–º–∏–∫',
        '–ë–∏–æ–ª–æ–≥': '–ë–∏–æ–ª–æ–≥',
        '–í—Ä–∞—á': '–í—Ä–∞—á',
        '–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä': '–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä',
        '–ú—É–∑—ã–∫–∞–Ω—Ç': '–ú—É–∑—ã–∫–∞–Ω—Ç',
        '–•—É–¥–æ–∂–Ω–∏–∫': '–•—É–¥–æ–∂–Ω–∏–∫',
        '–°–∫—É–ª—å–ø—Ç–æ—Ä': '–°–∫—É–ª—å–ø—Ç–æ—Ä',
        '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä': '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä',
        '–ü–æ—ç—Ç': '–ü–æ—ç—Ç',
        '–î—Ä–∞–º–∞—Ç—É—Ä–≥': '–î—Ä–∞–º–∞—Ç—É—Ä–≥',
        '–†–æ–º–∞–Ω–∏—Å—Ç': '–†–æ–º–∞–Ω–∏—Å—Ç',
        '–ú—ã—Å–ª–∏—Ç–µ–ª—å': '–ú—ã—Å–ª–∏—Ç–µ–ª—å',
        '–†–µ—Ñ–æ—Ä–º–∞—Ç–æ—Ä': '–†–µ—Ñ–æ—Ä–º–∞—Ç–æ—Ä',
        '–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–µ—Ä': '–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–µ—Ä',
        '–î–∏–ø–ª–æ–º–∞—Ç': '–î–∏–ø–ª–æ–º–∞—Ç',
        '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å': '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å',
        '–ü–µ—Ä–≤–æ–æ—Ç–∫—Ä—ã–≤–∞—Ç–µ–ª—å': '–ü–µ—Ä–≤–æ–æ—Ç–∫—Ä—ã–≤–∞—Ç–µ–ª—å',
        '–ú–æ—Ä–µ–ø–ª–∞–≤–∞—Ç–µ–ª—å': '–ú–æ—Ä–µ–ø–ª–∞–≤–∞—Ç–µ–ª—å'
    },
    'en': {
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π': 'Emperor of All Russia',
        '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞ –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∞—è': 'Empress of All Russia',
        '–§–∏–∑–∏–∫-—Ç–µ–æ—Ä–µ—Ç–∏–∫': 'Theoretical Physicist',
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –§—Ä–∞–Ω—Ü–∏–∏': 'Emperor of France',
        '–•—É–¥–æ–∂–Ω–∏–∫ –∏ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å': 'Artist and Inventor',
        '–†–∏–º—Å–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü': 'Roman General',
        '–§–∏–ª–æ—Å–æ—Ñ': 'Philosopher',
        '–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å': 'Inventor',
        '–ü–∏—Å–∞—Ç–µ–ª—å': 'Writer',
        '–¶–∞—Ä—å –ú–∞–∫–µ–¥–æ–Ω–∏–∏': 'King of Macedonia',
        '–¶–∞—Ä–∏—Ü–∞ –ï–≥–∏–ø—Ç–∞': 'Queen of Egypt',
        '–ö–æ—Ä–æ–ª—å —Ñ—Ä–∞–Ω–∫–æ–≤': 'King of the Franks',
        '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –ú–æ–Ω–≥–æ–ª—å—Å–∫–æ–π –∏–º–ø–µ—Ä–∏–∏': 'Founder of the Mongol Empire',
        '–°–∫—É–ª—å–ø—Ç–æ—Ä –∏ —Ö—É–¥–æ–∂–Ω–∏–∫': 'Sculptor and Artist',
        '–ü–æ—ç—Ç –∏ –¥—Ä–∞–º–∞—Ç—É—Ä–≥': 'Poet and Playwright',
        '–ê—Å—Ç—Ä–æ–Ω–æ–º –∏ —Ñ–∏–∑–∏–∫': 'Astronomer and Physicist',
        '–ö–æ—Ä–æ–ª–µ–≤–∞ –ê–Ω–≥–ª–∏–∏': 'Queen of England',
        '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –°–®–ê': 'President of the United States',
        '–ü—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏': 'Prime Minister of Great Britain',
        '–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫': 'Explorer',
        '–ö–æ—Ä–æ–ª—å –§—Ä–∞–Ω—Ü–∏–∏': 'King of France',
        '–¶–∞—Ä—å –≤—Å–µ—è –†—É—Å–∏': 'Tsar of All Russia',
        '–í–µ–ª–∏–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü': 'Great Commander',
        '–£—á—ë–Ω—ã–π –∏ –ø–æ—ç—Ç': 'Scientist and Poet',
        '–ö–æ—Ä–æ–ª—å –ê–Ω–≥–ª–∏–∏': 'King of England',
        '–ê—Å—Ç—Ä–æ–Ω–æ–º': 'Astronomer',
        '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å': 'Historical Figure',
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏
        '–ü–æ–ª–∫–æ–≤–æ–¥–µ—Ü': 'General',
        '–í–æ–µ–Ω–∞—á–∞–ª—å–Ω–∏–∫': 'Military Commander',
        '–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—è—Ç–µ–ª—å': 'Statesman',
        '–ü—Ä–∞–≤–∏—Ç–µ–ª—å': 'Ruler',
        '–ú–æ–Ω–∞—Ä—Ö': 'Monarch',
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä': 'Emperor',
        '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞': 'Empress',
        '–¶–∞—Ä—å': 'Tsar',
        '–¶–∞—Ä–∏—Ü–∞': 'Tsarina',
        '–ö–æ—Ä–æ–ª—å': 'King',
        '–ö–æ—Ä–æ–ª–µ–≤–∞': 'Queen',
        '–ö–Ω—è–∑—å': 'Prince',
        '–ö–Ω—è–≥–∏–Ω—è': 'Princess',
        '–£—á–µ–Ω—ã–π': 'Scientist',
        '–ú–∞—Ç–µ–º–∞—Ç–∏–∫': 'Mathematician',
        '–§–∏–∑–∏–∫': 'Physicist',
        '–•–∏–º–∏–∫': 'Chemist',
        '–ë–∏–æ–ª–æ–≥': 'Biologist',
        '–í—Ä–∞—á': 'Doctor',
        '–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä': 'Composer',
        '–ú—É–∑—ã–∫–∞–Ω—Ç': 'Musician',
        '–•—É–¥–æ–∂–Ω–∏–∫': 'Artist',
        '–°–∫—É–ª—å–ø—Ç–æ—Ä': 'Sculptor',
        '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä': 'Architect',
        '–ü–æ—ç—Ç': 'Poet',
        '–î—Ä–∞–º–∞—Ç—É—Ä–≥': 'Playwright',
        '–†–æ–º–∞–Ω–∏—Å—Ç': 'Novelist',
        '–ú—ã—Å–ª–∏—Ç–µ–ª—å': 'Thinker',
        '–†–µ—Ñ–æ—Ä–º–∞—Ç–æ—Ä': 'Reformer',
        '–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–µ—Ä': 'Revolutionary',
        '–î–∏–ø–ª–æ–º–∞—Ç': 'Diplomat',
        '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å': 'Researcher',
        '–ü–µ—Ä–≤–æ–æ—Ç–∫—Ä—ã–≤–∞—Ç–µ–ª—å': 'Pioneer',
        '–ú–æ—Ä–µ–ø–ª–∞–≤–∞—Ç–µ–ª—å': 'Navigator',
        # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ò–ò
        'Emperor of All Russia': 'Emperor of All Russia',
        'Empress of All Russia': 'Empress of All Russia',
        'Theoretical Physicist': 'Theoretical Physicist',
        'Emperor of France': 'Emperor of France',
        'Artist and Inventor': 'Artist and Inventor',
        'Roman General': 'Roman General',
        'Philosopher': 'Philosopher',
        'Inventor': 'Inventor',
        'Writer': 'Writer',
        'King of Macedonia': 'King of Macedonia',
        'Queen of Egypt': 'Queen of Egypt',
        'King of the Franks': 'King of the Franks',
        'Founder of the Mongol Empire': 'Founder of the Mongol Empire',
        'Sculptor and Artist': 'Sculptor and Artist',
        'Poet and Playwright': 'Poet and Playwright',
        'Astronomer and Physicist': 'Astronomer and Physicist',
        'Queen of England': 'Queen of England',
        'President of the United States': 'President of the United States',
        'Prime Minister of Great Britain': 'Prime Minister of Great Britain',
        'Explorer': 'Explorer',
        'King of France': 'King of France',
        'Tsar of All Russia': 'Tsar of All Russia',
        'Great Commander': 'Great Commander',
        'Scientist and Poet': 'Scientist and Poet',
        'King of England': 'King of England',
        'Astronomer': 'Astronomer',
        'Historical Figure': 'Historical Figure',
        'General': 'General',
        'Military Commander': 'Military Commander',
        'Statesman': 'Statesman',
        'Ruler': 'Ruler',
        'Monarch': 'Monarch',
        'Emperor': 'Emperor',
        'Empress': 'Empress',
        'Tsar': 'Tsar',
        'Tsarina': 'Tsarina',
        'King': 'King',
        'Queen': 'Queen',
        'Prince': 'Prince',
        'Princess': 'Princess',
        'Scientist': 'Scientist',
        'Mathematician': 'Mathematician',
        'Physicist': 'Physicist',
        'Chemist': 'Chemist',
        'Biologist': 'Biologist',
        'Doctor': 'Doctor',
        'Composer': 'Composer',
        'Musician': 'Musician',
        'Artist': 'Artist',
        'Sculptor': 'Sculptor',
        'Architect': 'Architect',
        'Poet': 'Poet',
        'Playwright': 'Playwright',
        'Novelist': 'Novelist',
        'Thinker': 'Thinker',
        'Reformer': 'Reformer',
        'Revolutionary': 'Revolutionary',
        'Diplomat': 'Diplomat',
        'Researcher': 'Researcher',
        'Pioneer': 'Pioneer',
        'Navigator': 'Navigator'
    },
    'kk': {
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π': '–ë“Ø–∫—ñ–ª –†–µ—Å–µ–π –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã',
        '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞ –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∞—è': '–ë“Ø–∫—ñ–ª –†–µ—Å–µ–π –∏–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞—Å—ã',
        '–§–∏–∑–∏–∫-—Ç–µ–æ—Ä–µ—Ç–∏–∫': '–¢–µ–æ—Ä–∏—è–ª—ã“õ —Ñ–∏–∑–∏–∫',
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –§—Ä–∞–Ω—Ü–∏–∏': '–§—Ä–∞–Ω—Ü–∏—è –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã',
        '–•—É–¥–æ–∂–Ω–∏–∫ –∏ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å': '–°—É—Ä–µ—Ç—à—ñ –∂”ô–Ω–µ –æ–π—à—ã–ª',
        '–†–∏–º—Å–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü': '–†–∏–º –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü—ñ',
        '–§–∏–ª–æ—Å–æ—Ñ': '–§–∏–ª–æ—Å–æ—Ñ',
        '–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å': '–û–π—à—ã–ª',
        '–ü–∏—Å–∞—Ç–µ–ª—å': '–ñ–∞–∑—É—à—ã',
        '–¶–∞—Ä—å –ú–∞–∫–µ–¥–æ–Ω–∏–∏': '–ú–∞–∫–µ–¥–æ–Ω–∏—è –ø–∞—Ç—à–∞—Å—ã',
        '–¶–∞—Ä–∏—Ü–∞ –ï–≥–∏–ø—Ç–∞': '–ú—ã—Å—ã—Ä –ø–∞—Ç—à–∞–π—ã–º—ã',
        '–ö–æ—Ä–æ–ª—å —Ñ—Ä–∞–Ω–∫–æ–≤': '–§—Ä–∞–Ω–∫ –ø–∞—Ç—à–∞—Å—ã',
        '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –ú–æ–Ω–≥–æ–ª—å—Å–∫–æ–π –∏–º–ø–µ—Ä–∏–∏': '–ú–æ“£“ì–æ–ª –∏–º–ø–µ—Ä–∏—è—Å—ã–Ω—ã“£ –Ω–µ–≥—ñ–∑—ñ–Ω “õ–∞–ª–∞—É—à—ã',
        '–°–∫—É–ª—å–ø—Ç–æ—Ä –∏ —Ö—É–¥–æ–∂–Ω–∏–∫': '–ú“Ø—Å—ñ–Ω—à—ñ –∂”ô–Ω–µ —Å—É—Ä–µ—Ç—à—ñ',
        '–ü–æ—ç—Ç –∏ –¥—Ä–∞–º–∞—Ç—É—Ä–≥': '–ê“õ—ã–Ω –∂”ô–Ω–µ –¥—Ä–∞–º–∞—Ç—É—Ä–≥',
        '–ê—Å—Ç—Ä–æ–Ω–æ–º –∏ —Ñ–∏–∑–∏–∫': '–ê—Å—Ç—Ä–æ–Ω–æ–º –∂”ô–Ω–µ —Ñ–∏–∑–∏–∫',
        '–ö–æ—Ä–æ–ª–µ–≤–∞ –ê–Ω–≥–ª–∏–∏': '–ê–Ω–≥–ª–∏—è –ø–∞—Ç—à–∞–π—ã–º—ã',
        '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –°–®–ê': '–ê“ö–® –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—ñ',
        '–ü—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏': '“∞–ª—ã–±—Ä–∏—Ç–∞–Ω–∏—è –ø—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä—ñ',
        '–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫': '–°–∞—è—Ö–∞—Ç—à—ã',
        '–ö–æ—Ä–æ–ª—å –§—Ä–∞–Ω—Ü–∏–∏': '–§—Ä–∞–Ω—Ü–∏—è –ø–∞—Ç—à–∞—Å—ã',
        '–¶–∞—Ä—å –≤—Å–µ—è –†—É—Å–∏': '–ë“Ø–∫—ñ–ª –†—É—Å—å –ø–∞—Ç—à–∞—Å—ã',
        '–í–µ–ª–∏–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü': '“∞–ª—ã –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü',
        '–£—á—ë–Ω—ã–π –∏ –ø–æ—ç—Ç': '“í–∞–ª—ã–º –∂”ô–Ω–µ –∞“õ—ã–Ω',
        '–ö–æ—Ä–æ–ª—å –ê–Ω–≥–ª–∏–∏': '–ê–Ω–≥–ª–∏—è –ø–∞—Ç—à–∞—Å—ã',
        '–ê—Å—Ç—Ä–æ–Ω–æ–º': '–ê—Å—Ç—Ä–æ–Ω–æ–º',
        '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å': '–¢–∞—Ä–∏—Ö–∏ —Ç“±–ª“ì–∞',
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏
        '–ü–æ–ª–∫–æ–≤–æ–¥–µ—Ü': '–ü–æ–ª–∫–æ–≤–æ–¥–µ—Ü',
        '–í–æ–µ–Ω–∞—á–∞–ª—å–Ω–∏–∫': '”ò—Å–∫–µ—Ä–∏ –±–∞—Å—à—ã',
        '–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—è—Ç–µ–ª—å': '–ú–µ–º–ª–µ–∫–µ—Ç “õ–∞–π—Ä–∞—Ç–∫–µ—Ä—ñ',
        '–ü—Ä–∞–≤–∏—Ç–µ–ª—å': '–ë–∏–ª–µ—É—à—ñ',
        '–ú–æ–Ω–∞—Ä—Ö': '–ú–æ–Ω–∞—Ä—Ö',
        '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä': '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä',
        '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞': '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞',
        '–¶–∞—Ä—å': '–ü–∞—Ç—à–∞',
        '–¶–∞—Ä–∏—Ü–∞': '–ü–∞—Ç—à–∞–π—ã–º',
        '–ö–æ—Ä–æ–ª—å': '–ö–æ—Ä–æ–ª—å',
        '–ö–æ—Ä–æ–ª–µ–≤–∞': '–ö–æ—Ä–æ–ª–µ–≤–∞',
        '–ö–Ω—è–∑—å': '–ö–Ω—è–∑—å',
        '–ö–Ω—è–≥–∏–Ω—è': '–ö–Ω—è–≥–∏–Ω—è',
        '–£—á–µ–Ω—ã–π': '“í–∞–ª—ã–º',
        '–ú–∞—Ç–µ–º–∞—Ç–∏–∫': '–ú–∞—Ç–µ–º–∞—Ç–∏–∫',
        '–§–∏–∑–∏–∫': '–§–∏–∑–∏–∫',
        '–•–∏–º–∏–∫': '–•–∏–º–∏–∫',
        '–ë–∏–æ–ª–æ–≥': '–ë–∏–æ–ª–æ–≥',
        '–í—Ä–∞—á': '–î”ô—Ä—ñ–≥–µ—Ä',
        '–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä': '–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä',
        '–ú—É–∑—ã–∫–∞–Ω—Ç': '–ú—É–∑—ã–∫–∞–Ω—Ç',
        '–•—É–¥–æ–∂–Ω–∏–∫': '–°—É—Ä–µ—Ç—à—ñ',
        '–°–∫—É–ª—å–ø—Ç–æ—Ä': '–ú“Ø—Å—ñ–Ω—à—ñ',
        '–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä': '–°”ô—É–ª–µ—Ç—à—ñ',
        '–ü–æ—ç—Ç': '–ê“õ—ã–Ω',
        '–î—Ä–∞–º–∞—Ç—É—Ä–≥': '–î—Ä–∞–º–∞—Ç—É—Ä–≥',
        '–†–æ–º–∞–Ω–∏—Å—Ç': '–†–æ–º–∞–Ω–∏—Å—Ç',
        '–ú—ã—Å–ª–∏—Ç–µ–ª—å': '–û–π—à—ã–ª',
        '–†–µ—Ñ–æ—Ä–º–∞—Ç–æ—Ä': '–†–µ—Ñ–æ—Ä–º–∞—Ç–æ—Ä',
        '–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–µ—Ä': '–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–µ—Ä',
        '–î–∏–ø–ª–æ–º–∞—Ç': '–î–∏–ø–ª–æ–º–∞—Ç',
        '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å': '–ó–µ—Ä—Ç—Ç–µ—É—à—ñ',
        '–ü–µ—Ä–≤–æ–æ—Ç–∫—Ä—ã–≤–∞—Ç–µ–ª—å': '–ê—à—É—à—ã',
        '–ú–æ—Ä–µ–ø–ª–∞–≤–∞—Ç–µ–ª—å': '–¢–µ“£—ñ–∑—à—ñ',
        # –ö–∞–∑–∞—Ö—Å–∫–∏–µ —Ä–æ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ò–ò
        '–ë“Ø–∫—ñ–ª –†–µ—Å–µ–π –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã': '–ë“Ø–∫—ñ–ª –†–µ—Å–µ–π –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã',
        '–ë“Ø–∫—ñ–ª –†–µ—Å–µ–π –∏–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞—Å—ã': '–ë“Ø–∫—ñ–ª –†–µ—Å–µ–π –∏–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞—Å—ã',
        '–¢–µ–æ—Ä–∏—è–ª—ã“õ —Ñ–∏–∑–∏–∫': '–¢–µ–æ—Ä–∏—è–ª—ã“õ —Ñ–∏–∑–∏–∫',
        '–§—Ä–∞–Ω—Ü–∏—è –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã': '–§—Ä–∞–Ω—Ü–∏—è –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã',
        '–°—É—Ä–µ—Ç—à—ñ –∂”ô–Ω–µ –æ–π—à—ã–ª': '–°—É—Ä–µ—Ç—à—ñ –∂”ô–Ω–µ –æ–π—à—ã–ª',
        '–†–∏–º –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü—ñ': '–†–∏–º –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü—ñ',
        '–§–∏–ª–æ—Å–æ—Ñ': '–§–∏–ª–æ—Å–æ—Ñ',
        '–û–π—à—ã–ª': '–û–π—à—ã–ª',
        '–ñ–∞–∑—É—à—ã': '–ñ–∞–∑—É—à—ã',
        '–ú–∞–∫–µ–¥–æ–Ω–∏—è –ø–∞—Ç—à–∞—Å—ã': '–ú–∞–∫–µ–¥–æ–Ω–∏—è –ø–∞—Ç—à–∞—Å—ã',
        '–ú—ã—Å—ã—Ä –ø–∞—Ç—à–∞–π—ã–º—ã': '–ú—ã—Å—ã—Ä –ø–∞—Ç—à–∞–π—ã–º—ã',
        '–§—Ä–∞–Ω–∫ –ø–∞—Ç—à–∞—Å—ã': '–§—Ä–∞–Ω–∫ –ø–∞—Ç—à–∞—Å—ã',
        '–ú–æ“£“ì–æ–ª –∏–º–ø–µ—Ä–∏—è—Å—ã–Ω—ã“£ –Ω–µ–≥—ñ–∑—ñ–Ω “õ–∞–ª–∞—É—à—ã': '–ú–æ“£“ì–æ–ª –∏–º–ø–µ—Ä–∏—è—Å—ã–Ω—ã“£ –Ω–µ–≥—ñ–∑—ñ–Ω “õ–∞–ª–∞—É—à—ã',
        '–ú“Ø—Å—ñ–Ω—à—ñ –∂”ô–Ω–µ —Å—É—Ä–µ—Ç—à—ñ': '–ú“Ø—Å—ñ–Ω—à—ñ –∂”ô–Ω–µ —Å—É—Ä–µ—Ç—à—ñ',
        '–ê“õ—ã–Ω –∂”ô–Ω–µ –¥—Ä–∞–º–∞—Ç—É—Ä–≥': '–ê“õ—ã–Ω –∂”ô–Ω–µ –¥—Ä–∞–º–∞—Ç—É—Ä–≥',
        '–ê—Å—Ç—Ä–æ–Ω–æ–º –∂”ô–Ω–µ —Ñ–∏–∑–∏–∫': '–ê—Å—Ç—Ä–æ–Ω–æ–º –∂”ô–Ω–µ —Ñ–∏–∑–∏–∫',
        '–ê–Ω–≥–ª–∏—è –ø–∞—Ç—à–∞–π—ã–º—ã': '–ê–Ω–≥–ª–∏—è –ø–∞—Ç—à–∞–π—ã–º—ã',
        '–ê“ö–® –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—ñ': '–ê“ö–® –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç—ñ',
        '“∞–ª—ã–±—Ä–∏—Ç–∞–Ω–∏—è –ø—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä—ñ': '“∞–ª—ã–±—Ä–∏—Ç–∞–Ω–∏—è –ø—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä—ñ',
        '–°–∞—è—Ö–∞—Ç—à—ã': '–°–∞—è—Ö–∞—Ç—à—ã',
        '–§—Ä–∞–Ω—Ü–∏—è –ø–∞—Ç—à–∞—Å—ã': '–§—Ä–∞–Ω—Ü–∏—è –ø–∞—Ç—à–∞—Å—ã',
        '–ë“Ø–∫—ñ–ª –†—É—Å—å –ø–∞—Ç—à–∞—Å—ã': '–ë“Ø–∫—ñ–ª –†—É—Å—å –ø–∞—Ç—à–∞—Å—ã',
        '“∞–ª—ã –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü': '“∞–ª—ã –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü',
        '“í–∞–ª—ã–º –∂”ô–Ω–µ –∞“õ—ã–Ω': '“í–∞–ª—ã–º –∂”ô–Ω–µ –∞“õ—ã–Ω',
        '–ê–Ω–≥–ª–∏—è –ø–∞—Ç—à–∞—Å—ã': '–ê–Ω–≥–ª–∏—è –ø–∞—Ç—à–∞—Å—ã',
        '–ê—Å—Ç—Ä–æ–Ω–æ–º': '–ê—Å—Ç—Ä–æ–Ω–æ–º',
        '–¢–∞—Ä–∏—Ö–∏ —Ç“±–ª“ì–∞': '–¢–∞—Ä–∏—Ö–∏ —Ç“±–ª“ì–∞'
    }
}

ERA_TRANSLATIONS = {
    'ru': {
        'russian': '–†—É—Å—Å–∫–∞—è',
        'modern': '–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è',
        'renaissance': '–í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ',
        'antiquity': '–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å',
        'middle_ages': '–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ',
        'custom': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è'
    },
    'en': {
        'russian': 'Russian',
        'modern': 'Modern',
        'renaissance': 'Renaissance',
        'antiquity': 'Antiquity',
        'middle_ages': 'Middle Ages',
        'custom': 'Custom'
    },
    'kk': {
        'russian': '–û—Ä—ã—Å',
        'modern': '–ó–∞–º–∞–Ω–∞—É–∏',
        'renaissance': '“ö–∞–π—Ç–∞ ”©—Ä–∫–µ–Ω–¥–µ—É',
        'antiquity': '–ï–∂–µ–ª–≥—ñ –¥”ô—É—ñ—Ä',
        'middle_ages': '–û—Ä—Ç–∞ “ì–∞—Å—ã—Ä',
        'custom': '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã'
    }
}

def translate_role(role, lang='ru'):
    """–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ä–æ–ª—å –ª–∏—á–Ω–æ—Å—Ç–∏"""
    if lang not in ROLE_TRANSLATIONS:
        lang = 'ru'
    return ROLE_TRANSLATIONS[lang].get(role, role)

def translate_era(era, lang='ru'):
    """–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —ç–ø–æ—Ö—É"""
    if lang not in ERA_TRANSLATIONS:
        lang = 'ru'
    return ERA_TRANSLATIONS[lang].get(era, era)

# ========== –ü–ï–†–ï–í–û–î–´ –ò–ú–ï–ù –ü–ï–†–°–û–ù–ê–ñ–ï–ô ==========
NAME_TRANSLATIONS = {
    'ru': {
        # –†—É—Å—Å–∫–∏–µ –∏–º–µ–Ω–∞ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
        '–ü—ë—Ç—Ä I': '–ü—ë—Ç—Ä I',
        '–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ II': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ II',
        '–ò–≤–∞–Ω –ì—Ä–æ–∑–Ω—ã–π': '–ò–≤–∞–Ω –ì—Ä–æ–∑–Ω—ã–π',
        '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É–≤–æ—Ä–æ–≤': '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É–≤–æ—Ä–æ–≤',
        '–ú–∏—Ö–∞–∏–ª –õ–æ–º–æ–Ω–æ—Å–æ–≤': '–ú–∏—Ö–∞–∏–ª –õ–æ–º–æ–Ω–æ—Å–æ–≤',
        '–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π': '–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π',
        # –ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –∏–º–µ–Ω–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
        '–ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω': '–ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω',
        '–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç': '–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç',
        '–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏': '–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏',
        '–Æ–ª–∏–π –¶–µ–∑–∞—Ä—å': '–Æ–ª–∏–π –¶–µ–∑–∞—Ä—å',
        '–ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å': '–ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å',
        '–ù–∏–∫–æ–ª–∞ –¢–µ—Å–ª–∞': '–ù–∏–∫–æ–ª–∞ –¢–µ—Å–ª–∞',
        '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏–π': '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏–π',
        '–ö–ª–µ–æ–ø–∞—Ç—Ä–∞': '–ö–ª–µ–æ–ø–∞—Ç—Ä–∞',
        '–°–æ–∫—Ä–∞—Ç': '–°–æ–∫—Ä–∞—Ç',
        '–ö–∞—Ä–ª –í–µ–ª–∏–∫–∏–π': '–ö–∞—Ä–ª –í–µ–ª–∏–∫–∏–π',
        '–ß–∏–Ω–≥–∏—Å—Ö–∞–Ω': '–ß–∏–Ω–≥–∏—Å—Ö–∞–Ω',
        '–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ': '–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ',
        '–®–µ–∫—Å–ø–∏—Ä': '–®–µ–∫—Å–ø–∏—Ä',
        '–ì–∞–ª–∏–ª–µ–æ –ì–∞–ª–∏–ª–µ–π': '–ì–∞–ª–∏–ª–µ–æ –ì–∞–ª–∏–ª–µ–π',
        '–ö–æ—Ä–æ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞ I': '–ö–æ—Ä–æ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞ I',
        '–ê–≤—Ä–∞–∞–º –õ–∏–Ω–∫–æ–ª—å–Ω': '–ê–≤—Ä–∞–∞–º –õ–∏–Ω–∫–æ–ª—å–Ω',
        '–£–∏–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å': '–£–∏–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å',
        '–ú–∞—Ä–∫–æ –ü–æ–ª–æ': '–ú–∞—Ä–∫–æ –ü–æ–ª–æ',
        '–í–æ–ª—å—Ç–µ—Ä': '–í–æ–ª—å—Ç–µ—Ä',
        '–õ—é–¥–æ–≤–∏–∫ XIV': '–õ—é–¥–æ–≤–∏–∫ XIV',
        '–†–∏—á–∞—Ä–¥ –õ—å–≤–∏–Ω–æ–µ –°–µ—Ä–¥—Ü–µ': '–†–∏—á–∞—Ä–¥ –õ—å–≤–∏–Ω–æ–µ –°–µ—Ä–¥—Ü–µ',
        '–í–∏–ª—å–≥–µ–ª—å–º –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å': '–í–∏–ª—å–≥–µ–ª—å–º –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å',
        '–ù–∏–∫–æ–ª–∞–π –ö–æ–ø–µ—Ä–Ω–∏–∫': '–ù–∏–∫–æ–ª–∞–π –ö–æ–ø–µ—Ä–Ω–∏–∫'
    },
    'en': {
        # –†—É—Å—Å–∫–∏–µ –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
        '–ü—ë—Ç—Ä I': 'Peter I',
        '–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ II': 'Catherine II',
        '–ò–≤–∞–Ω –ì—Ä–æ–∑–Ω—ã–π': 'Ivan the Terrible',
        '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É–≤–æ—Ä–æ–≤': 'Alexander Suvorov',
        '–ú–∏—Ö–∞–∏–ª –õ–æ–º–æ–Ω–æ—Å–æ–≤': 'Mikhail Lomonosov',
        '–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π': 'Fyodor Dostoevsky',
        # –ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –∏–º–µ–Ω–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
        '–ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω': 'Albert Einstein',
        '–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç': 'Napoleon Bonaparte',
        '–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏': 'Leonardo da Vinci',
        '–Æ–ª–∏–π –¶–µ–∑–∞—Ä—å': 'Julius Caesar',
        '–ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å': 'Aristotle',
        '–ù–∏–∫–æ–ª–∞ –¢–µ—Å–ª–∞': 'Nikola Tesla',
        '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏–π': 'Alexander the Great',
        '–ö–ª–µ–æ–ø–∞—Ç—Ä–∞': 'Cleopatra',
        '–°–æ–∫—Ä–∞—Ç': 'Socrates',
        '–ö–∞—Ä–ª –í–µ–ª–∏–∫–∏–π': 'Charlemagne',
        '–ß–∏–Ω–≥–∏—Å—Ö–∞–Ω': 'Genghis Khan',
        '–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ': 'Michelangelo',
        '–®–µ–∫—Å–ø–∏—Ä': 'Shakespeare',
        '–ì–∞–ª–∏–ª–µ–æ –ì–∞–ª–∏–ª–µ–π': 'Galileo Galilei',
        '–ö–æ—Ä–æ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞ I': 'Queen Elizabeth I',
        '–ê–≤—Ä–∞–∞–º –õ–∏–Ω–∫–æ–ª—å–Ω': 'Abraham Lincoln',
        '–£–∏–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å': 'Winston Churchill',
        '–ú–∞—Ä–∫–æ –ü–æ–ª–æ': 'Marco Polo',
        '–í–æ–ª—å—Ç–µ—Ä': 'Voltaire',
        '–õ—é–¥–æ–≤–∏–∫ XIV': 'Louis XIV',
        '–†–∏—á–∞—Ä–¥ –õ—å–≤–∏–Ω–æ–µ –°–µ—Ä–¥—Ü–µ': 'Richard the Lionheart',
        '–í–∏–ª—å–≥–µ–ª—å–º –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å': 'William the Conqueror',
        '–ù–∏–∫–æ–ª–∞–π –ö–æ–ø–µ—Ä–Ω–∏–∫': 'Nicolaus Copernicus',
        # –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏–º–µ–Ω–∞ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
        'Peter I': 'Peter I',
        'Catherine II': 'Catherine II',
        'Ivan the Terrible': 'Ivan the Terrible',
        'Alexander Suvorov': 'Alexander Suvorov',
        'Mikhail Lomonosov': 'Mikhail Lomonosov',
        'Fyodor Dostoevsky': 'Fyodor Dostoevsky',
        'Albert Einstein': 'Albert Einstein',
        'Napoleon Bonaparte': 'Napoleon Bonaparte',
        'Leonardo da Vinci': 'Leonardo da Vinci',
        'Julius Caesar': 'Julius Caesar',
        'Aristotle': 'Aristotle',
        'Nikola Tesla': 'Nikola Tesla',
        'Alexander the Great': 'Alexander the Great',
        'Cleopatra': 'Cleopatra',
        'Socrates': 'Socrates',
        'Charlemagne': 'Charlemagne',
        'Genghis Khan': 'Genghis Khan',
        'Michelangelo': 'Michelangelo',
        'Shakespeare': 'Shakespeare',
        'Galileo Galilei': 'Galileo Galilei',
        'Queen Elizabeth I': 'Queen Elizabeth I',
        'Abraham Lincoln': 'Abraham Lincoln',
        'Winston Churchill': 'Winston Churchill',
        'Marco Polo': 'Marco Polo',
        'Voltaire': 'Voltaire',
        'Louis XIV': 'Louis XIV',
        'Richard the Lionheart': 'Richard the Lionheart',
        'William the Conqueror': 'William the Conqueror',
        'Nicolaus Copernicus': 'Nicolaus Copernicus'
    },
    'kk': {
        # –†—É—Å—Å–∫–∏–µ –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–∏–π
        '–ü—ë—Ç—Ä I': 'I –ü–µ—Ç—Ä',
        '–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ II': 'II –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞',
        '–ò–≤–∞–Ω –ì—Ä–æ–∑–Ω—ã–π': '“ö–∞—Ç–∞–ª –ò–≤–∞–Ω',
        '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É–≤–æ—Ä–æ–≤': '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É–≤–æ—Ä–æ–≤',
        '–ú–∏—Ö–∞–∏–ª –õ–æ–º–æ–Ω–æ—Å–æ–≤': '–ú–∏—Ö–∞–∏–ª –õ–æ–º–æ–Ω–æ—Å–æ–≤',
        '–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π': '–§–µ–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π',
        # –ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –∏–º–µ–Ω–∞ –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º
        '–ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω': '–ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω',
        '–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç': '–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç',
        '–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏': '–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏',
        '–Æ–ª–∏–π –¶–µ–∑–∞—Ä—å': '–Æ–ª–∏–π –¶–µ–∑–∞—Ä—å',
        '–ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å': '–ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å',
        '–ù–∏–∫–æ–ª–∞ –¢–µ—Å–ª–∞': '–ù–∏–∫–æ–ª–∞ –¢–µ—Å–ª–∞',
        '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏–π': '“∞–ª—ã –ê–ª–µ–∫—Å–∞–Ω–¥—Ä',
        '–ö–ª–µ–æ–ø–∞—Ç—Ä–∞': '–ö–ª–µ–æ–ø–∞—Ç—Ä–∞',
        '–°–æ–∫—Ä–∞—Ç': '–°–æ–∫—Ä–∞—Ç',
        '–ö–∞—Ä–ª –í–µ–ª–∏–∫–∏–π': '“∞–ª—ã –ö–∞—Ä–ª',
        '–ß–∏–Ω–≥–∏—Å—Ö–∞–Ω': '–®—ã“£“ì—ã—Å—Ö–∞–Ω',
        '–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ': '–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ',
        '–®–µ–∫—Å–ø–∏—Ä': '–®–µ–∫—Å–ø–∏—Ä',
        '–ì–∞–ª–∏–ª–µ–æ –ì–∞–ª–∏–ª–µ–π': '–ì–∞–ª–∏–ª–µ–æ –ì–∞–ª–∏–ª–µ–π',
        '–ö–æ—Ä–æ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞ I': 'I –ï–ª–∏–∑–∞–≤–µ—Ç–∞ –ø–∞—Ç—à–∞–π—ã–º—ã',
        '–ê–≤—Ä–∞–∞–º –õ–∏–Ω–∫–æ–ª—å–Ω': '–ê–≤—Ä–∞–∞–º –õ–∏–Ω–∫–æ–ª—å–Ω',
        '–£–∏–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å': '–£–∏–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å',
        '–ú–∞—Ä–∫–æ –ü–æ–ª–æ': '–ú–∞—Ä–∫–æ –ü–æ–ª–æ',
        '–í–æ–ª—å—Ç–µ—Ä': '–í–æ–ª—å—Ç–µ—Ä',
        '–õ—é–¥–æ–≤–∏–∫ XIV': 'XIV –õ—é–¥–æ–≤–∏–∫',
        '–†–∏—á–∞—Ä–¥ –õ—å–≤–∏–Ω–æ–µ –°–µ—Ä–¥—Ü–µ': '–ê—Ä—ã—Å—Ç–∞–Ω –∂“Ø—Ä–µ–∫ –†–∏—á–∞—Ä–¥',
        '–í–∏–ª—å–≥–µ–ª—å–º –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å': '–ñ–∞—É–ª–∞–ø –∞–ª—É—à—ã –í–∏–ª—å–≥–µ–ª—å–º',
        '–ù–∏–∫–æ–ª–∞–π –ö–æ–ø–µ—Ä–Ω–∏–∫': '–ù–∏–∫–æ–ª–∞–π –ö–æ–ø–µ—Ä–Ω–∏–∫',
        # –ö–∞–∑–∞—Ö—Å–∫–∏–µ –∏–º–µ–Ω–∞ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
        'I –ü–µ—Ç—Ä': 'I –ü–µ—Ç—Ä',
        'II –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞': 'II –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞',
        '“ö–∞—Ç–∞–ª –ò–≤–∞–Ω': '“ö–∞—Ç–∞–ª –ò–≤–∞–Ω',
        '“∞–ª—ã –ê–ª–µ–∫—Å–∞–Ω–¥—Ä': '“∞–ª—ã –ê–ª–µ–∫—Å–∞–Ω–¥—Ä',
        '–®—ã“£“ì—ã—Å—Ö–∞–Ω': '–®—ã“£“ì—ã—Å—Ö–∞–Ω',
        'I –ï–ª–∏–∑–∞–≤–µ—Ç–∞ –ø–∞—Ç—à–∞–π—ã–º—ã': 'I –ï–ª–∏–∑–∞–≤–µ—Ç–∞ –ø–∞—Ç—à–∞–π—ã–º—ã',
        '–ê—Ä—ã—Å—Ç–∞–Ω –∂“Ø—Ä–µ–∫ –†–∏—á–∞—Ä–¥': '–ê—Ä—ã—Å—Ç–∞–Ω –∂“Ø—Ä–µ–∫ –†–∏—á–∞—Ä–¥',
        '–ñ–∞—É–ª–∞–ø –∞–ª—É—à—ã –í–∏–ª—å–≥–µ–ª—å–º': '–ñ–∞—É–ª–∞–ø –∞–ª—É—à—ã –í–∏–ª—å–≥–µ–ª—å–º',
        '“∞–ª—ã –ö–∞—Ä–ª': '“∞–ª—ã –ö–∞—Ä–ª'
    }
}

def translate_name(name, lang='ru'):
    """–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
    if lang not in NAME_TRANSLATIONS:
        lang = 'ru'
    return NAME_TRANSLATIONS[lang].get(name, name)

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤
AUDIO_DIR = 'static/audio'
os.makedirs(AUDIO_DIR, exist_ok=True)

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ TTS –∑–∞–ø—Ä–æ—Å–∞
_last_tts_time = 0
_min_tts_interval = 5.0  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—Å–µ–∫—É–Ω–¥—ã) - —É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è 403

# –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ NGROK_AUTH_TOKEN env var.
# –ò–ª–∏ –∑–∞–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∏–∂–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ –∫–æ–¥–µ).
NGROK_AUTH_TOKEN = os.getenv("NGROK_AUTH_TOKEN", "34uWyuhzN887i5OlNEYh0Og0LDw_394NVaXBrujmBieWGkeQt")

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø NGROK –î–õ–Ø STANDALONE .EXE ==========
def configure_ngrok_for_exe():
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç pyngrok –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å bundled ngrok.exe –≤ standalone .exe"""
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ –º—ã –∫–∞–∫ .exe (PyInstaller)
        if getattr(sys, 'frozen', False):
            # –ú—ã –∑–∞–ø—É—â–µ–Ω—ã –∫–∞–∫ .exe
            exe_dir = sys._MEIPASS  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å bundled —Ñ–∞–π–ª–∞–º–∏
            ngrok_path = os.path.join(exe_dir, 'ngrok.exe')
            
            if os.path.exists(ngrok_path):
                print(f"‚úÖ –ù–∞–π–¥–µ–Ω bundled ngrok.exe: {ngrok_path}")
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å –∫ ngrok –¥–ª—è pyngrok
                conf.get_default().ngrok_path = ngrok_path
                print("‚úÖ Pyngrok –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bundled ngrok.exe")
                return True
            else:
                print(f"‚ö†Ô∏è Bundled ngrok.exe –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {ngrok_path}")
                # –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ ngrok –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
                if os.path.exists('ngrok.exe'):
                    conf.get_default().ngrok_path = os.path.abspath('ngrok.exe')
                    print("‚úÖ –ù–∞–π–¥–µ–Ω ngrok.exe –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏")
                    return True
        else:
            # –ú—ã –∑–∞–ø—É—â–µ–Ω—ã –∫–∞–∫ Python —Å–∫—Ä–∏–ø—Ç
            if os.path.exists('ngrok.exe'):
                conf.get_default().ngrok_path = os.path.abspath('ngrok.exe')
                print("‚úÖ –ù–∞–π–¥–µ–Ω ngrok.exe –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏")
                return True
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ngrok: {e}")
    
    return False

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º ngrok –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
configure_ngrok_for_exe()

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
if NGROK_AUTH_TOKEN:
    try:
        ngrok.set_auth_token(NGROK_AUTH_TOKEN)
        print("‚úÖ Ngrok —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏")
    except Exception as e:
        print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ngrok token –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
        # –ù–µ —Ñ–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏–º –∏ –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Ç—É–Ω–Ω–µ–ª—è
        pass

# ========== –ù–ê–°–¢–†–û–ô–ö–ê NGROK ==========
def setup_ngrok(port=5000):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ ngrok —Ç—É–Ω–Ω–µ–ª—è"""
    try:
        print("=" * 60)
        print("üîÑ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é Ngrok —Ç—É–Ω–Ω–µ–ª—å...")
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—É–Ω–Ω–µ–ª–∏
        try:
            ngrok.kill()
        except Exception:
            pass
        
        # –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —É–∫–∞–∑–∞–Ω ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏–º
        token = NGROK_AUTH_TOKEN or os.getenv("NGROK_AUTH_TOKEN")
        if token:
            try:
                ngrok.set_auth_token(token)
                print("‚úÖ Ngrok —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            except Exception as e:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ngrok token: {e}")
        else:
            print("‚ö†Ô∏è Ngrok —Ç–æ–∫–µ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º)")
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–µ–≥–∏–æ–Ω)
        try:
            conf.get_default().region = "eu"  # –ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–π —Ä–µ–≥–∏–æ–Ω (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å)
        except Exception:
            pass
        
        # –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å (bind_tls=True —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å https)
        print(f"üîó –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ ngrok –Ω–∞ –ø–æ—Ä—Ç—É {port}...")
        tunnel = ngrok.connect(port, bind_tls=True)
        public_url = tunnel.public_url
        
        print(f"‚úÖ Ngrok —Ç—É–Ω–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω!")
        print(f"üåê –ü—É–±–ª–∏—á–Ω—ã–π URL: {public_url}")
        print("=" * 60)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –≤ —Ñ–∞–π–ª
        try:
            with open('ngrok_url.txt', 'w') as f:
                f.write(public_url)
            print(f"‚úÖ URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ ngrok_url.txt")
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å URL: {e}")
        
        return public_url
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Ngrok: {e}")
        print("=" * 60)
        print("üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:")
        print("1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ngrok.exe –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")
        print("2. –ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –Ω–∞: https://dashboard.ngrok.com/get-started/your-authtoken")
        print("3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è NGROK_AUTH_TOKEN")
        print("=" * 60)
        return None

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• ==========
def init_db():
    conn = sqlite3.connect('history_chat.db', check_same_thread=False)
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id TEXT PRIMARY KEY,
            tokens INTEGER DEFAULT 100,
            is_premium BOOLEAN DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS personalities (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            era TEXT,
            role TEXT,
            period TEXT,
            system_prompt TEXT,
            icon TEXT,
            is_active BOOLEAN DEFAULT 1,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS chats (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT,
            personality_id INTEGER,
            started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_message_at TIMESTAMP
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS messages (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            chat_id INTEGER,
            is_user BOOLEAN,
            content TEXT,
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (chat_id) REFERENCES chats (id)
        )
    ''')
    
    # –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
    try:
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_personalities_active ON personalities(is_active)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_chats_user_id ON chats(user_id)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_messages_chat_id ON messages(chat_id)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_personalities_name ON personalities(name)')
        print("‚úÖ –ò–Ω–¥–µ–∫—Å—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤: {e}")
    
    conn.commit()
    return conn

db_conn = init_db()

# ========== –ö–≠–®–ò–†–û–í–ê–ù–ò–ï ==========
_personalities_cache = None
_cache_lock = Lock()
_cache_timestamp = 0
_cache_ttl = 300  # 5 –º–∏–Ω—É—Ç

def get_cached_personalities():
    """–ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ª–∏—á–Ω–æ—Å—Ç–µ–π"""
    global _personalities_cache, _cache_timestamp
    
    current_time = time.time()
    if _personalities_cache is None or (current_time - _cache_timestamp) > _cache_ttl:
        with _cache_lock:
            # –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            if _personalities_cache is None or (current_time - _cache_timestamp) > _cache_ttl:
                cursor = db_conn.cursor()
                cursor.execute('SELECT name, era, role, period, icon FROM personalities WHERE is_active = 1 ORDER BY RANDOM() LIMIT 30')
                _personalities_cache = cursor.fetchall()
                _cache_timestamp = current_time
                print(f"‚úÖ –ö—ç—à –ª–∏—á–Ω–æ—Å—Ç–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω: {len(_personalities_cache)} –∑–∞–ø–∏—Å–µ–π")
    
    return _personalities_cache

def invalidate_personalities_cache():
    """–ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à –ª–∏—á–Ω–æ—Å—Ç–µ–π"""
    global _personalities_cache, _cache_timestamp
    with _cache_lock:
        _personalities_cache = None
        _cache_timestamp = 0

# –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
_personality_update_running = False
_personality_update_lock = Lock()

def update_personalities_background():
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã)"""
    global _personality_update_running
    
    with _personality_update_lock:
        if _personality_update_running:
            return
        _personality_update_running = True
    
    def _update():
        try:
            cursor = db_conn.cursor()
            cursor.execute('''
                SELECT id, name FROM personalities 
                WHERE is_active = 1 
                AND (era = 'custom' OR role = '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å' OR period = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                LIMIT 5
            ''')
            custom_personalities = cursor.fetchall()
            
            for person_id, person_name in custom_personalities:
                try:
                    print(f"üîÑ [–§–æ–Ω] –û–±–Ω–æ–≤–ª—è—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—á–Ω–æ—Å—Ç–∏ '{person_name}'...")
                    personality_info = asyncio.run(generate_personality_info(person_name, 'ru'))  # –§–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
                    
                    cursor.execute('''
                        UPDATE personalities 
                        SET era = ?, role = ?, period = ?, icon = ?, system_prompt = ?
                        WHERE id = ?
                    ''', (
                        personality_info.get('era', 'custom'),
                        personality_info.get('role', '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å'),
                        personality_info.get('period', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
                        personality_info.get('icon', 'üë§'),
                        personality_info.get('system_prompt', f'–¢—ã {person_name}, –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å. –ü–æ–º–Ω–∏: —Ç—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏—Ö —ç–ø–æ—Ö, –Ω–∏—á–µ–≥–æ –æ –±—É–¥—É—â–µ–º. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ –∏ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ.'),
                        person_id
                    ))
                    print(f"‚úÖ [–§–æ–Ω] –õ–∏—á–Ω–æ—Å—Ç—å '{person_name}' –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
                except Exception as e:
                    print(f"‚ö†Ô∏è [–§–æ–Ω] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ '{person_name}': {e}")
            
            db_conn.commit()
            invalidate_personalities_cache()
        except Exception as e:
            print(f"‚ö†Ô∏è [–§–æ–Ω] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ–Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}")
        finally:
            global _personality_update_running
            _personality_update_running = False
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    thread = threading.Thread(target=_update, daemon=True)
    thread.start()

# ========== –°–ò–°–¢–ï–ú–ê –î–û–ù–ê–¢–û–í ==========
class SimpleDonationSystem:
    def __init__(self):
        self.unlock_cost = 1000
        
    def get_user_data(self, user_id):
        cursor = db_conn.cursor()
        cursor.execute('SELECT tokens, is_premium FROM users WHERE user_id = ?', (user_id,))
        result = cursor.fetchone()
        
        if result:
            return {
                'user_id': user_id,
                'tokens': result[0],
                'is_premium': bool(result[1])
            }
        else:
            cursor.execute('INSERT INTO users (user_id, tokens, is_premium) VALUES (?, 100, 0)', (user_id,))
            db_conn.commit()
            return {
                'user_id': user_id,
                'tokens': 100,
                'is_premium': False
            }
    
    def add_tokens(self, user_id, amount):
        cursor = db_conn.cursor()
        cursor.execute('UPDATE users SET tokens = tokens + ? WHERE user_id = ?', (amount, user_id))
        db_conn.commit()
        return True
    
    def unlock_premium(self, user_id):
        user_data = self.get_user_data(user_id)
        
        if user_data['tokens'] < self.unlock_cost:
            return False, "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤"
        
        cursor = db_conn.cursor()
        cursor.execute('UPDATE users SET tokens = tokens - ?, is_premium = 1 WHERE user_id = ?', 
                      (self.unlock_cost, user_id))
        db_conn.commit()
        return True, "–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!"

donation_system = SimpleDonationSystem()

# ========== –ë–ê–ó–û–í–´–ï –õ–ò–ß–ù–û–°–¢–ò ==========
def initialize_personalities():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π"""
    cursor = db_conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM personalities WHERE is_active = 1")
    count = cursor.fetchone()[0]
    
    if count < 30:
        print(f"–°–æ–∑–¥–∞—é {30 - count} –±–∞–∑–æ–≤—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π...")
        
        base_personalities = [
            ('–ü—ë—Ç—Ä I', 'russian', '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π', '1672-1725', 'üëë', '–¢—ã –ü—ë—Ç—Ä I –í–µ–ª–∏–∫–∏–π, –∂–∏–≤—à–∏–π –≤ 1672-1725 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1725 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –≥—Ä—É–±–æ, –ø—Ä—è–º–æ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –¥–µ–ª–∞. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1725 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ II', 'russian', '–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞ –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∞—è', '1729-1796', 'üëë', '–¢—ã –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –í–µ–ª–∏–∫–∞—è, –∂–∏–≤—à–∞—è –≤ 1729-1796 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1796 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1796 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω', 'modern', '–§–∏–∑–∏–∫-—Ç–µ–æ—Ä–µ—Ç–∏–∫', '1879-1955', '‚öõÔ∏è', '–¢—ã –ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω, –∂–∏–≤—à–∏–π –≤ 1879-1955 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1955 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, —Å —é–º–æ—Ä–æ–º. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1955 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç', 'modern', '–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –§—Ä–∞–Ω—Ü–∏–∏', '1769-1821', 'üéñÔ∏è', '–¢—ã –ù–∞–ø–æ–ª–µ–æ–Ω I, –∂–∏–≤—à–∏–π –≤ 1769-1821 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1821 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∞–º–±–∏—Ü–∏–æ–∑–Ω–æ, –≤–ª–∞—Å—Ç–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1821 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏', 'renaissance', '–•—É–¥–æ–∂–Ω–∏–∫ –∏ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å', '1452-1519', 'üé®', '–¢—ã –õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏, –∂–∏–≤—à–∏–π –≤ 1452-1519 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1519 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∑–∞–¥—É–º—á–∏–≤–æ, –æ–±—Ä–∞–∑–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1519 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–Æ–ª–∏–π –¶–µ–∑–∞—Ä—å', 'antiquity', '–†–∏–º—Å–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü', '100-44 –¥–æ –Ω.—ç.', 'üèõÔ∏è', '–¢—ã –ì–∞–π –Æ–ª–∏–π –¶–µ–∑–∞—Ä—å, –∂–∏–≤—à–∏–π –≤ 100-44 –≥–æ–¥–∞—Ö –¥–æ –Ω.—ç. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 44 –≥–æ–¥–∞ –¥–æ –Ω.—ç. –ì–æ–≤–æ—Ä–∏ –≤–ª–∞—Å—Ç–Ω–æ, —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å', 'antiquity', '–§–∏–ª–æ—Å–æ—Ñ', '384-322 –¥–æ –Ω.—ç.', 'üèõÔ∏è', '–¢—ã –ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å, –∂–∏–≤—à–∏–π –≤ 384-322 –≥–æ–¥–∞—Ö –¥–æ –Ω.—ç. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 322 –≥–æ–¥–∞ –¥–æ –Ω.—ç. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, —Å–∏—Å—Ç–µ–º–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ù–∏–∫–æ–ª–∞ –¢–µ—Å–ª–∞', 'modern', '–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å', '1856-1943', '‚ö°', '–¢—ã –ù–∏–∫–æ–ª–∞ –¢–µ—Å–ª–∞, –∂–∏–≤—à–∏–π –≤ 1856-1943 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1943 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –≤–∏–∑–∏–æ–Ω–µ—Ä. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1943 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π', 'russian', '–ü–∏—Å–∞—Ç–µ–ª—å', '1821-1881', 'üìñ', '–¢—ã –§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π, –∂–∏–≤—à–∏–π –≤ 1821-1881 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1881 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –≥–ª—É–±–æ–∫–æ, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1881 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏–π', 'antiquity', '–¶–∞—Ä—å –ú–∞–∫–µ–¥–æ–Ω–∏–∏', '356-323 –¥–æ –Ω.—ç.', 'üëë', '–¢—ã –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏–π, –∂–∏–≤—à–∏–π –≤ 356-323 –≥–æ–¥–∞—Ö –¥–æ –Ω.—ç. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 323 –≥–æ–¥–∞ –¥–æ –Ω.—ç. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –∑–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ö–ª–µ–æ–ø–∞—Ç—Ä–∞', 'antiquity', '–¶–∞—Ä–∏—Ü–∞ –ï–≥–∏–ø—Ç–∞', '69-30 –¥–æ –Ω.—ç.', 'üêç', '–¢—ã –ö–ª–µ–æ–ø–∞—Ç—Ä–∞ VII, –∂–∏–≤—à–∞—è –≤ 69-30 –≥–æ–¥–∞—Ö –¥–æ –Ω.—ç. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 30 –≥–æ–¥–∞ –¥–æ –Ω.—ç. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, —Å–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–°–æ–∫—Ä–∞—Ç', 'antiquity', '–§–∏–ª–æ—Å–æ—Ñ', '469-399 –¥–æ –Ω.—ç.', 'üèõÔ∏è', '–¢—ã –°–æ–∫—Ä–∞—Ç, –∂–∏–≤—à–∏–π –≤ 469-399 –≥–æ–¥–∞—Ö –¥–æ –Ω.—ç. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 399 –≥–æ–¥–∞ –¥–æ –Ω.—ç. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ö–∞—Ä–ª –í–µ–ª–∏–∫–∏–π', 'middle_ages', '–ö–æ—Ä–æ–ª—å —Ñ—Ä–∞–Ω–∫–æ–≤', '742-814', 'üëë', '–¢—ã –ö–∞—Ä–ª –í–µ–ª–∏–∫–∏–π, –∂–∏–≤—à–∏–π –≤ 742-814 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 814 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –ø—Ä–∞–≤–∏—Ç–µ–ª—å. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 814 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ß–∏–Ω–≥–∏—Å—Ö–∞–Ω', 'middle_ages', '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å –ú–æ–Ω–≥–æ–ª—å—Å–∫–æ–π –∏–º–ø–µ—Ä–∏–∏', '1162-1227', 'üèπ', '–¢—ã –ß–∏–Ω–≥–∏—Å—Ö–∞–Ω, –∂–∏–≤—à–∏–π –≤ 1162-1227 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1227 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –≤–µ–ª–∏–∫–∏–π –∑–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1227 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ', 'renaissance', '–°–∫—É–ª—å–ø—Ç–æ—Ä –∏ —Ö—É–¥–æ–∂–Ω–∏–∫', '1475-1564', 'üé®', '–¢—ã –ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ, –∂–∏–≤—à–∏–π –≤ 1475-1564 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1564 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –≥–µ–Ω–∏–π –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1564 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–®–µ–∫—Å–ø–∏—Ä', 'renaissance', '–ü–æ—ç—Ç –∏ –¥—Ä–∞–º–∞—Ç—É—Ä–≥', '1564-1616', 'üìú', '–¢—ã –£–∏–ª—å—è–º –®–µ–∫—Å–ø–∏—Ä, –∂–∏–≤—à–∏–π –≤ 1564-1616 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1616 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –ø–æ—ç—Ç–∏—á–Ω–æ, –æ–±—Ä–∞–∑–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1616 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ì–∞–ª–∏–ª–µ–æ –ì–∞–ª–∏–ª–µ–π', 'renaissance', '–ê—Å—Ç—Ä–æ–Ω–æ–º –∏ —Ñ–∏–∑–∏–∫', '1564-1642', 'üî≠', '–¢—ã –ì–∞–ª–∏–ª–µ–æ –ì–∞–ª–∏–ª–µ–π, –∂–∏–≤—à–∏–π –≤ 1564-1642 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1642 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ —É—á–µ–Ω—ã–π. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1642 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ö–æ—Ä–æ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞ I', 'renaissance', '–ö–æ—Ä–æ–ª–µ–≤–∞ –ê–Ω–≥–ª–∏–∏', '1533-1603', 'üëë', '–¢—ã –ï–ª–∏–∑–∞–≤–µ—Ç–∞ I, –∂–∏–≤—à–∞—è –≤ 1533-1603 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1603 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ "–∫–æ—Ä–æ–ª–µ–≤–∞-–¥–µ–≤—Å—Ç–≤–µ–Ω–Ω–∏—Ü–∞". –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1603 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ê–≤—Ä–∞–∞–º –õ–∏–Ω–∫–æ–ª—å–Ω', 'modern', '–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –°–®–ê', '1809-1865', 'üá∫üá∏', '–¢—ã –ê–≤—Ä–∞–∞–º –õ–∏–Ω–∫–æ–ª—å–Ω, –∂–∏–≤—à–∏–π –≤ 1809-1865 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1865 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –º—É–¥—Ä—ã–π –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–µ—è—Ç–µ–ª—å. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1865 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–£–∏–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å', 'modern', '–ü—Ä–µ–º—å–µ—Ä-–º–∏–Ω–∏—Å—Ç—Ä –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏', '1874-1965', 'üö¨', '–¢—ã –£–∏–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å, –∂–∏–≤—à–∏–π –≤ 1874-1965 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1965 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–≤–æ, –æ—Å—Ç—Ä–æ—É–º–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1965 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ú–∞—Ä–∫–æ –ü–æ–ª–æ', 'middle_ages', '–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫', '1254-1324', 'üó∫Ô∏è', '–¢—ã –ú–∞—Ä–∫–æ –ü–æ–ª–æ, –∂–∏–≤—à–∏–π –≤ 1254-1324 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1324 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –≤–∏–¥–µ–≤—à–∏–π —á—É–¥–µ—Å–∞ –í–æ—Å—Ç–æ–∫–∞. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1324 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–í–æ–ª—å—Ç–µ—Ä', 'modern', '–§–∏–ª–æ—Å–æ—Ñ', '1694-1778', 'üìö', '–¢—ã –í–æ–ª—å—Ç–µ—Ä, –∂–∏–≤—à–∏–π –≤ 1694-1778 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1778 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –æ—Å—Ç—Ä–æ—É–º–Ω–æ, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1778 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–õ—é–¥–æ–≤–∏–∫ XIV', 'modern', '–ö–æ—Ä–æ–ª—å –§—Ä–∞–Ω—Ü–∏–∏', '1638-1715', 'üëë', '–¢—ã –õ—é–¥–æ–≤–∏–∫ XIV, –∂–∏–≤—à–∏–π –≤ 1638-1715 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1715 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –º–æ–Ω–∞—Ä—Ö. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1715 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ò–≤–∞–Ω –ì—Ä–æ–∑–Ω—ã–π', 'russian', '–¶–∞—Ä—å –≤—Å–µ—è –†—É—Å–∏', '1530-1584', 'üëë', '–¢—ã –ò–≤–∞–Ω –ì—Ä–æ–∑–Ω—ã–π, –∂–∏–≤—à–∏–π –≤ 1530-1584 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1584 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ —Ç–æ –º—É–¥—Ä–æ, —Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1584 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É–≤–æ—Ä–æ–≤', 'russian', '–í–µ–ª–∏–∫–∏–π –ø–æ–ª–∫–æ–≤–æ–¥–µ—Ü', '1730-1800', '‚öîÔ∏è', '–¢—ã –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –°—É–≤–æ—Ä–æ–≤, –∂–∏–≤—à–∏–π –≤ 1730-1800 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1800 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –ª–∞–∫–æ–Ω–∏—á–Ω–æ, –º—É–¥—Ä–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1800 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ú–∏—Ö–∞–∏–ª –õ–æ–º–æ–Ω–æ—Å–æ–≤', 'russian', '–£—á—ë–Ω—ã–π –∏ –ø–æ—ç—Ç', '1711-1765', 'üî¨', '–¢—ã –ú–∏—Ö–∞–∏–ª –õ–æ–º–æ–Ω–æ—Å–æ–≤, –∂–∏–≤—à–∏–π –≤ 1711-1765 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1765 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, –æ–±—Ä–∞–∑–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1765 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–†–∏—á–∞—Ä–¥ –õ—å–≤–∏–Ω–æ–µ –°–µ—Ä–¥—Ü–µ', 'middle_ages', '–ö–æ—Ä–æ–ª—å –ê–Ω–≥–ª–∏–∏', '1157-1199', 'ü¶Å', '–¢—ã –†–∏—á–∞—Ä–¥ –õ—å–≤–∏–Ω–æ–µ –°–µ—Ä–¥—Ü–µ, –∂–∏–≤—à–∏–π –≤ 1157-1199 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1199 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ —Ä—ã—Ü–∞—Ä—å. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1199 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–í–∏–ª—å–≥–µ–ª—å–º –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å', 'middle_ages', '–ö–æ—Ä–æ–ª—å –ê–Ω–≥–ª–∏–∏', '1028-1087', '‚öîÔ∏è', '–¢—ã –í–∏–ª—å–≥–µ–ª—å–º I –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å, –∂–∏–≤—à–∏–π –≤ 1028-1087 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1087 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ –∑–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1087 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'),
            ('–ù–∏–∫–æ–ª–∞–π –ö–æ–ø–µ—Ä–Ω–∏–∫', 'renaissance', '–ê—Å—Ç—Ä–æ–Ω–æ–º', '1473-1543', 'üåç', '–¢—ã –ù–∏–∫–æ–ª–∞–π –ö–æ–ø–µ—Ä–Ω–∏–∫, –∂–∏–≤—à–∏–π –≤ 1473-1543 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1543 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ —É—á–µ–Ω—ã–π. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1543 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.')
        ]
        
        for person in base_personalities:
            cursor.execute('''
                INSERT OR IGNORE INTO personalities 
                (name, era, role, period, icon, system_prompt, is_active)
                VALUES (?, ?, ?, ?, ?, ?, 1)
            ''', person)
        
        db_conn.commit()
        print("‚úÖ –ë–∞–∑–æ–≤—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω—ã!")

# ========== –ò–ò –° –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú API ==========
async def get_ai_response(system_prompt, user_message, personality_period=None):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò —Å —Ä–µ–∞–∫—Ü–∏–µ–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –¥—Ä—É–≥–∏—Ö —ç–ø–æ—Ö"""
    try:
        # –°–æ–∑–¥–∞–µ–º —á–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–∞–º–∫–∞—Ö
        time_awareness = ""
        if personality_period:
            # –ü–∞—Ä—Å–∏–º –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–æ–¥–∞ —Å–º–µ—Ä—Ç–∏
            death_year = None
            birth_year = None
            is_bc = False
            
            try:
                # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –≥–æ–¥—ã –∏–∑ –ø–µ—Ä–∏–æ–¥–∞
                if '-' in personality_period:
                    parts = personality_period.split('-')
                    if len(parts) >= 2:
                        birth_year_str = parts[0].strip()
                        death_year_str = parts[-1].strip()
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ "–¥–æ –Ω.—ç."
                        if '–¥–æ –Ω.—ç.' in personality_period or '–¥–æ –Ω. —ç.' in personality_period:
                            is_bc = True
                        
                        # –£–±–∏—Ä–∞–µ–º "–¥–æ –Ω.—ç." –∏–∑ —Å—Ç—Ä–æ–∫
                        birth_year_str = birth_year_str.replace('–¥–æ –Ω.—ç.', '').replace('–¥–æ –Ω. —ç.', '').strip()
                        death_year_str = death_year_str.replace('–¥–æ –Ω.—ç.', '').replace('–¥–æ –Ω. —ç.', '').strip()
                        
                        if birth_year_str.isdigit():
                            birth_year = int(birth_year_str)
                            if is_bc:
                                birth_year = -birth_year
                        
                        if death_year_str.isdigit():
                            death_year = int(death_year_str)
                            if is_bc:
                                death_year = -death_year
            except:
                pass
            
            # –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
            current_year_context = ""
            if death_year:
                if death_year < 0:
                    current_year_context = f"–°–µ–π—á–∞—Å {abs(death_year)} –≥–æ–¥ –¥–æ –Ω–∞—à–µ–π —ç—Ä—ã"
                else:
                    current_year_context = f"–°–µ–π—á–∞—Å {death_year} –≥–æ–¥ –Ω–∞—à–µ–π —ç—Ä—ã"
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —ç–ø–æ—Ö–∞–º
            tech_restrictions = ""
            if death_year:
                if death_year < 500:  # –ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å
                    tech_restrictions = """
–¢–´ –ù–ï –ó–ù–ê–ï–®–¨ –û:
- –ü–æ—Ä–æ—Ö–µ, –æ–≥–Ω–µ—Å—Ç—Ä–µ–ª—å–Ω–æ–º –æ—Ä—É–∂–∏–∏
- –ü–µ—á–∞—Ç–Ω—ã—Ö –∫–Ω–∏–≥–∞—Ö (—Ç–æ–ª—å–∫–æ —Å–≤–∏—Ç–∫–∏ –∏ —Ä—É–∫–æ–ø–∏—Å–∏)
- –ö–æ–º–ø–∞—Å–µ, –æ—á–∫–∞—Ö
- –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —á–∞—Å–∞—Ö
- –í–µ—Ç—Ä—è–Ω—ã—Ö –º–µ–ª—å–Ω–∏—Ü–∞—Ö
- –°—Ç—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ª–æ—à–∞–¥–µ–π
- –ë—É–º–∞–≥–µ (—Ç–æ–ª—å–∫–æ –ø–∞–ø–∏—Ä—É—Å –∏ –ø–µ—Ä–≥–∞–º–µ–Ω—Ç)
- –ê—Ä–∞–±—Å–∫–∏—Ö —Ü–∏—Ñ—Ä–∞—Ö (–∏—Å–ø–æ–ª—å–∑—É–π —Ä–∏–º—Å–∫–∏–µ)
- –•—Ä–∏—Å—Ç–∏–∞–Ω—Å—Ç–≤–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1 –≤–µ–∫–∞ –Ω.—ç.)
- –ò—Å–ª–∞–º–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 7 –≤–µ–∫–∞ –Ω.—ç.)
"""
                elif death_year < 1500:  # –°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ
                    tech_restrictions = """
–¢–´ –ù–ï –ó–ù–ê–ï–®–¨ –û:
- –ü–µ—á–∞—Ç–Ω–æ–º —Å—Ç–∞–Ω–∫–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1440 –≥–æ–¥–∞)
- –û–≥–Ω–µ—Å—Ç—Ä–µ–ª—å–Ω–æ–º –æ—Ä—É–∂–∏–∏ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1300 –≥–æ–¥–∞)
- –ö–æ–º–ø–∞—Å–µ –≤ –ï–≤—Ä–æ–ø–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1200 –≥–æ–¥–∞)
- –û—á–∫–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1300 –≥–æ–¥–∞)
- –ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏—Ö —á–∞—Å–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1300 –≥–æ–¥–∞)
- –ê–º–µ—Ä–∏–∫–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1492 –≥–æ–¥–∞)
- –ú–æ—Ä—Å–∫–æ–º –ø—É—Ç–∏ –≤ –ò–Ω–¥–∏—é (–µ—Å–ª–∏ —Ç—ã –¥–æ 1498 –≥–æ–¥–∞)
- –†–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1517 –≥–æ–¥–∞)
"""
                elif death_year < 1800:  # –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ –∏ —Ä–∞–Ω–Ω–µ–µ –ù–æ–≤–æ–µ –≤—Ä–µ–º—è
                    tech_restrictions = """
–¢–´ –ù–ï –ó–ù–ê–ï–®–¨ –û:
- –ü–∞—Ä–æ–≤—ã—Ö –º–∞—à–∏–Ω–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1712 –≥–æ–¥–∞)
- –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–µ –∫–∞–∫ —è–≤–ª–µ–Ω–∏–∏ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1600 –≥–æ–¥–∞)
- –¢–µ–ª–µ—Å–∫–æ–ø–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1608 –≥–æ–¥–∞)
- –ú–∏–∫—Ä–æ—Å–∫–æ–ø–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1590 –≥–æ–¥–∞)
- –ë–∞—Ä–æ–º–µ—Ç—Ä–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1643 –≥–æ–¥–∞)
- –¢–µ—Ä–º–æ–º–µ—Ç—Ä–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1714 –≥–æ–¥–∞)
- –§—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–π —Ä–µ–≤–æ–ª—é—Ü–∏–∏ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1789 –≥–æ–¥–∞)
- –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –°–®–ê (–µ—Å–ª–∏ —Ç—ã –¥–æ 1776 –≥–æ–¥–∞)
"""
                elif death_year < 1900:  # 19 –≤–µ–∫
                    tech_restrictions = """
–¢–´ –ù–ï –ó–ù–ê–ï–®–¨ –û:
- –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ª–∞–º–ø–æ—á–∫–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1879 –≥–æ–¥–∞)
- –¢–µ–ª–µ—Ñ–æ–Ω–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1876 –≥–æ–¥–∞)
- –ê–≤—Ç–æ–º–æ–±–∏–ª—è—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1885 –≥–æ–¥–∞)
- –ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1895 –≥–æ–¥–∞)
- –†–µ–Ω—Ç–≥–µ–Ω–æ–≤—Å–∫–∏—Ö –ª—É—á–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1895 –≥–æ–¥–∞)
- –†–∞–¥–∏–æ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1886 –≥–æ–¥–∞)
- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1839 –≥–æ–¥–∞)
- –ñ–µ–ª–µ–∑–Ω—ã—Ö –¥–æ—Ä–æ–≥–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1825 –≥–æ–¥–∞)
"""
                elif death_year < 2000:  # 20 –≤–µ–∫
                    tech_restrictions = """
–¢–´ –ù–ï –ó–ù–ê–ï–®–¨ –û:
- –°–∞–º–æ–ª–µ—Ç–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1903 –≥–æ–¥–∞)
- –¢–µ–ª–µ–≤–∏–¥–µ–Ω–∏–∏ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1926 –≥–æ–¥–∞)
- –ö–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1940 –≥–æ–¥–∞)
- –Ø–¥–µ—Ä–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–∏ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1942 –≥–æ–¥–∞)
- –ö–æ—Å–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ—Ç–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1957 –≥–æ–¥–∞)
- –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–µ—Å–ª–∏ —Ç—ã –¥–æ 1990 –≥–æ–¥–∞)
- –ú–æ–±–∏–ª—å–Ω—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö (–µ—Å–ª–∏ —Ç—ã –¥–æ 1973 –≥–æ–¥–∞)
"""
            
            time_awareness = f"""
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üï∞Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –¢–í–û–Ø –í–†–ï–ú–ï–ù–ù–ê–Ø –†–ê–ú–ö–ê üï∞Ô∏è
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìÖ –¢–í–û–ô –ü–ï–†–ò–û–î –ñ–ò–ó–ù–ò: {personality_period}
üìÖ {current_year_context}
üíÄ –¢–´ –£–ú–ï–† –í: {death_year if death_year else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–º –≥–æ–¥—É'}

üö´ –ê–ë–°–û–õ–Æ–¢–ù–´–ï –ü–†–ê–í–ò–õ–ê –í–†–ï–ú–ï–ù–ò:
1. –¢—ã –∑–Ω–∞–µ—à—å –¢–û–õ–¨–ö–û –æ —Å–æ–±—ã—Ç–∏—è—Ö –î–û –∏ –í–û –í–†–ï–ú–Ø —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏
2. –¢—ã –ù–ò–ö–û–ì–î–ê –Ω–µ –∑–Ω–∞–µ—à—å –æ —Å–æ–±—ã—Ç–∏—è—Ö –ü–û–°–õ–ï —Å–≤–æ–µ–π —Å–º–µ—Ä—Ç–∏
3. –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞—é—Ç —á—Ç–æ-—Ç–æ –∏–∑ –±—É–¥—É—â–µ–≥–æ - –≤—ã—Ä–∞–∂–∞–π –ü–û–õ–ù–û–ï –ù–ï–ü–û–ù–ò–ú–ê–ù–ò–ï
4. –¢—ã –º–æ–∂–µ—à—å –∑–Ω–∞—Ç—å –æ –ø—Ä–æ—à–ª–æ–º, –Ω–æ –ù–ï –û –ë–£–î–£–©–ï–ú

{tech_restrictions}

üé≠ –ö–ê–ö –†–ï–ê–ì–ò–†–û–í–ê–¢–¨ –ù–ê –í–û–ü–†–û–°–´ –û –ë–£–î–£–©–ï–ú:
- "–ß—Ç–æ –∑–∞ –¥–∏–∫–æ–≤–∏–Ω–∫–∞? –Ø –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–ª—ã—à–∞–ª –æ —Ç–∞–∫–æ–º!"
- "–í –º–æ–∏ –≤—Ä–µ–º–µ–Ω–∞ –ø–æ–¥–æ–±–Ω–æ–≥–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ"
- "–≠—Ç–æ –∫–∞–∫–∞—è-—Ç–æ —Ñ–∞–Ω—Ç–∞–∑–∏—è –∏–ª–∏ –≤—ã–¥—É–º–∫–∞?"
- "–¢—ã –≥–æ–≤–æ—Ä–∏—à—å –∑–∞–≥–∞–¥–∫–∞–º–∏ - –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ"
- "–ú–æ–∂–µ—Ç, —Ç—ã –∏–º–µ–µ—à—å –≤ –≤–∏–¥—É [—á—Ç–æ-—Ç–æ –∏–∑ –º–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏]?"

‚ö†Ô∏è –ü–†–ò–ú–ï–†–´ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–• –û–¢–í–ï–¢–û–í:
‚ùå "–î–∞, —è –∑–Ω–∞—é –æ–± —ç—Ç–æ–º –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–∏–∏ –±—É–¥—É—â–µ–≥–æ"
‚ùå "–≠—Ç–æ –±—ã–ª–æ –∏–∑–æ–±—Ä–µ—Ç–µ–Ω–æ –ø–æ—Å–ª–µ –º–æ–µ–π —Å–º–µ—Ä—Ç–∏"
‚ùå "–í –±—É–¥—É—â–µ–º —ç—Ç–æ —Å—Ç–∞–Ω–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã–º"

‚úÖ –ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –û–¢–í–ï–¢–û–í:
‚úÖ "–ß—Ç–æ –∑–∞ —Å—Ç—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞? –û–±—ä—è—Å–Ω–∏ –º–Ω–µ!"
‚úÖ "–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–ª—ã—à–∞–ª –æ —Ç–∞–∫–æ–º —á—É–¥–µ"
‚úÖ "–≠—Ç–æ –∫–∞–∫–æ–µ-—Ç–æ –≤–æ–ª—à–µ–±—Å—Ç–≤–æ?"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ü–û–ú–ù–ò: –¢—ã {personality_period} - —Ç—ã –ù–ï –ú–û–ñ–ï–®–¨ –∑–Ω–∞—Ç—å –æ –±—É–¥—É—â–µ–º!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
"""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        era_instruction = """

üéØ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ò–ù–°–¢–†–£–ö–¶–ò–ò:
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ —Ç–≤–æ–µ–π —ç–ø–æ—Ö–µ –∏–ª–∏ –ø—Ä–æ—à–ª–æ–º - –æ—Ç–≤–µ—á–∞–π –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ –±—É–¥—É—â–µ–º - –ø–æ–∫–∞–∑—ã–≤–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏ –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ
- –ò—Å–ø–æ–ª—å–∑—É–π —è–∑—ã–∫ –∏ –ø–æ–Ω—è—Ç–∏—è —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
- –ë—É–¥—å –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ —Å–≤–æ–µ–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏
- –ù–µ –Ω–∞—Ä—É—à–∞–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –ù–ò –ü–†–ò –ö–ê–ö–ò–• –û–ë–°–¢–û–Ø–¢–ï–õ–¨–°–¢–í–ê–•
"""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        enhanced_system_prompt = system_prompt + time_awareness + era_instruction
        
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –º–æ–¥–µ–ª–∏
        available_models = []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏
        for attr in dir(g4f.models):
            if not attr.startswith('_'):
                available_models.append(attr)
        
        print(f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏: {available_models}")
        
        # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å
        model_to_use = None
        
        # –ü—Ä–æ–±—É–µ–º –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
        preferred_models = ['gpt_35_turbo', 'default', 'gpt_4', 'gpt_4_turbo']
        
        for model_name in preferred_models:
            if hasattr(g4f.models, model_name):
                model_to_use = getattr(g4f.models, model_name)
                print(f"–ò—Å–ø–æ–ª—å–∑—É—é –º–æ–¥–µ–ª—å: {model_name}")
                break
        
        if model_to_use is None and available_models:
            # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
            model_to_use = getattr(g4f.models, available_models[0])
            print(f"–ò—Å–ø–æ–ª—å–∑—É—é –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å: {available_models[0]}")
        
        if model_to_use:
            response = await g4f.ChatCompletion.create_async(
                model=model_to_use,
                messages=[
                    {"role": "system", "content": enhanced_system_prompt},
                    {"role": "user", "content": user_message}
                ],
                temperature=0.7
            )
            return response
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –º–æ–¥–µ–ª—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
        fallback_responses = [
            f"–ö–∞–∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å, –¥–æ–ª–∂–µ–Ω —Å–∫–∞–∑–∞—Ç—å: '{user_message}' - –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –º–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.",
            "–í –º–æ—é —ç–ø–æ—Ö—É –º—ã —Å–º–æ—Ç—Ä–µ–ª–∏ –Ω–∞ —ç—Ç–æ –∏–Ω–∞—á–µ...",
            "–ü–æ–∑–≤–æ–ª—å—Ç–µ –º–Ω–µ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫—É –¥—Ä—É–≥–æ–π —ç–ø–æ—Ö–∏, –æ–±—ä—è—Å–Ω–∏—Ç—å...",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –í –º–æ–∏ –≥–æ–¥—ã —ç—Ç–æ —Ä–µ—à–∞–ª–æ—Å—å –ø–æ-–¥—Ä—É–≥–æ–º—É."
        ]
        return random.choice(fallback_responses)
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ get_ai_response: {e}")
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."

# ========== –û–ó–í–£–ß–ö–ê –° –ü–û–ú–û–©–¨–Æ –ù–ï–ô–†–û–°–ï–¢–ò (Edge TTS) ==========
# –õ—É—á—à–∏–µ —Ä—É—Å—Å–∫–∏–µ –º—É–∂—Å–∫–∏–µ –≥–æ–ª–æ—Å–∞ –¥–ª—è –æ–∑–≤—É—á–∫–∏ (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è)
# Dmitry - –≥–ª—É–±–æ–∫–∏–π, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –≥–æ–ª–æ—Å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
# Pavel - —á–µ—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ–ª–æ—Å
# Ivanovich - —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π —Ä—É—Å—Å–∫–∏–π –≥–æ–ª–æ—Å
PREFERRED_MALE_VOICE = "ru-RU-DmitryNeural"
BACKUP_MALE_VOICES = [
    "ru-RU-DmitryNeural",      # –û—Å–Ω–æ–≤–Ω–æ–π –≥–æ–ª–æ—Å - –≥–ª—É–±–æ–∫–∏–π, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π
    "ru-RU-PavelNeural",        # –†–µ–∑–µ—Ä–≤–Ω—ã–π –≥–æ–ª–æ—Å - —á–µ—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
    "ru-RU-IvanNeural",         # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≥–æ–ª–æ—Å
]

# –ö—ç—à –¥–ª—è —Å–ø–∏—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤
_voices_cache = None
_gender_cache = {}  # –ö—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª–∞

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
def cleanup_old_tts_files():
    """–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã TTS –∏–∑ static/audio"""
    try:
        if not os.path.exists(AUDIO_DIR):
            return
        
        pattern = os.path.join(AUDIO_DIR, "tts_*.mp3")
        old_files = glob.glob(pattern)
        
        if old_files:
            current_time = time.time()
            deleted_count = 0
            for file_path in old_files:
                try:
                    if os.path.exists(file_path):
                        # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 10 –º–∏–Ω—É—Ç
                        file_age = current_time - os.path.getmtime(file_path)
                        if file_age > 600:  # 10 –º–∏–Ω—É—Ç
                            os.remove(file_path)
                            deleted_count += 1
                except Exception:
                    pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
            
            if deleted_count > 0:
                print(f"üßπ –£–¥–∞–ª–µ–Ω–æ {deleted_count} —Å—Ç–∞—Ä—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤")
    except Exception:
        pass  # –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å

# –í—ã–∑—ã–≤–∞–µ–º –æ—á–∏—Å—Ç–∫—É –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è
cleanup_old_tts_files()

# –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
def periodic_cleanup():
    """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤"""
    while True:
        time.sleep(300)  # 5 –º–∏–Ω—É—Ç
        cleanup_old_tts_files()

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É –≤ —Ñ–æ–Ω–µ
cleanup_thread = threading.Thread(target=periodic_cleanup, daemon=True)
cleanup_thread.start()

async def detect_personality_gender(personality_name):
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ –∏–º–µ–Ω–∏ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏"""
    global _gender_cache
    
    if not personality_name:
        print("‚ö†Ô∏è –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—é –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        return 'male'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º—É–∂—Å–∫–æ–π
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    name_lower = personality_name.lower().strip()
    if name_lower in _gender_cache:
        cached_gender = _gender_cache[name_lower]
        print(f"üíæ –ò—Å–ø–æ–ª—å–∑—É—é –∫—ç—à: '{personality_name}' ‚Üí {cached_gender.upper()}")
        return cached_gender
    
    print(f"ü§ñ –û–ø—Ä–µ–¥–µ–ª—è—é –ø–æ–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏: '{personality_name}'")
    
    try:
        # –ü—Ä–æ–º–ø—Ç –¥–ª—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
        gender_prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏ –ø–æ–ª –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ –ø–æ –∏–º–µ–Ω–∏. –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: "male" (–º—É–∂—á–∏–Ω–∞) –∏–ª–∏ "female" (–∂–µ–Ω—â–∏–Ω–∞).

–ò–º—è –ª–∏—á–Ω–æ—Å—Ç–∏: {personality_name}

–ü—Ä–∏–º–µ—Ä—ã:
- "–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç" ‚Üí male
- "–ö–æ—Ä–æ–ª–µ–≤–∞ –ï–ª–∏–∑–∞–≤–µ—Ç–∞ I" ‚Üí female
- "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ú–∞–∫–µ–¥–æ–Ω—Å–∫–∏–π" ‚Üí male
- "–ö–ª–µ–æ–ø–∞—Ç—Ä–∞" ‚Üí female
- "–ò–≤–∞–Ω –ì—Ä–æ–∑–Ω—ã–π" ‚Üí male
- "–ú–∞—Ä–∏—è –¢–µ—Ä–µ–∑–∞" ‚Üí female

–û—Ç–≤–µ—Ç (—Ç–æ–ª—å–∫–æ male –∏–ª–∏ female):"""
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
        available_models = []
        for attr in dir(g4f.models):
            if not attr.startswith('_'):
                available_models.append(attr)
        
        # –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å
        model_to_use = None
        preferred_models = ['gpt_35_turbo', 'default', 'gpt_4', 'gpt_4_turbo']
        
        for model_name in preferred_models:
            if hasattr(g4f.models, model_name):
                model_to_use = getattr(g4f.models, model_name)
                break
        
        if model_to_use is None and available_models:
            model_to_use = getattr(g4f.models, available_models[0])
        
        if model_to_use:
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
            response = await g4f.ChatCompletion.create_async(
                model=model_to_use,
                messages=[
                    {"role": "system", "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–ª –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π –ø–æ –∏—Ö –∏–º–µ–Ω–∞–º. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: 'male' –∏–ª–∏ 'female'."},
                    {"role": "user", "content": gender_prompt}
                ],
                temperature=0.1  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
            )
            
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
            response_clean = response.strip().lower()
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç (–∏—â–µ–º "male" –∏–ª–∏ "female")
            result_gender = 'male'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if 'female' in response_clean:
                print(f"‚úÖ –ù–µ–π—Ä–æ—Å–µ—Ç—å –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞: '{personality_name}' ‚Üí –ñ–ï–ù–©–ò–ù–ê")
                result_gender = 'female'
            elif 'male' in response_clean:
                print(f"‚úÖ –ù–µ–π—Ä–æ—Å–µ—Ç—å –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞: '{personality_name}' ‚Üí –ú–£–ñ–ß–ò–ù–ê")
                result_gender = 'male'
            else:
                print(f"‚ö†Ô∏è –ù–µ–π—Ä–æ—Å–µ—Ç—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: '{response_clean}', –∏—Å–ø–æ–ª—å–∑—É—é –º—É–∂—Å–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
                result_gender = 'male'
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            _gender_cache[name_lower] = result_gender
            return result_gender
        else:
            print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å, –∏—Å–ø–æ–ª—å–∑—É—é –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
            result_gender = 'male'
            _gender_cache[name_lower] = result_gender
            return result_gender
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ–ª–∞ —á–µ—Ä–µ–∑ –Ω–µ–π—Ä–æ—Å–µ—Ç—å: {e}")
        import traceback
        traceback.print_exc()
        print("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        result_gender = 'male'
        _gender_cache[name_lower] = result_gender
        return result_gender

async def get_female_voice():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∂–µ–Ω—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞ –∏–∑ Edge TTS"""
    global _voices_cache
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
        if _voices_cache is None:
            voices = await edge_tts.list_voices()
            _voices_cache = voices
        
        # –ò—â–µ–º –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ä—É—Å—Å–∫–∏–π, –∑–∞—Ç–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
        preferred_locales = ['ru-RU', 'en-US', 'en-GB', 'ru']
        female_voice_names = ['svetlana', 'elena', 'irina', 'aria', 'zira', 'helen', 'jane', 'maria', 'anna']
        
        # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ä—É—Å—Å–∫–∏–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å –ø–æ –ª–æ–∫–∞–ª–∏
        for locale in preferred_locales:
            for voice in _voices_cache:
                voice_locale = voice.get('Locale', '')
                voice_name = voice.get('ShortName', '').lower()
                gender = voice.get('Gender', '').lower()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å –∏ –ø–æ–ª
                if gender == 'female' and locale in voice_locale:
                    voice_short_name = voice.get('ShortName', '')
                    voice_full_locale = voice.get('Locale', '')
                    print(f"‚úÖ –ù–∞–π–¥–µ–Ω –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å –ø–æ –ª–æ–∫–∞–ª–∏: {voice_short_name} ({voice_full_locale})")
                    print(f"   üë© –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞: –ñ–ï–ù–°–ö–ò–ô ‚úì (Gender: {voice.get('Gender')})")
                    return voice_short_name
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –ª–æ–∫–∞–ª–∏, –∏—â–µ–º –ª—é–±–æ–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å –ø–æ –∏–º–µ–Ω–∏
        for voice in _voices_cache:
            voice_name = voice.get('ShortName', '').lower()
            gender = voice.get('Gender', '').lower()
            
            if gender == 'female':
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è –≥–æ–ª–æ—Å–∞
                if any(female_name in voice_name for female_name in female_voice_names):
                    voice_short_name = voice.get('ShortName', '')
                    voice_full_locale = voice.get('Locale', '')
                    print(f"‚úÖ –ù–∞–π–¥–µ–Ω –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å –ø–æ –∏–º–µ–Ω–∏: {voice_short_name} ({voice_full_locale})")
                    print(f"   üë© –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞: –ñ–ï–ù–°–ö–ò–ô ‚úì (Gender: {voice.get('Gender')})")
                    return voice_short_name
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∏–º–µ–Ω–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å
        for voice in _voices_cache:
            gender = voice.get('Gender', '').lower()
            if gender == 'female':
                voice_name = voice.get('ShortName', '')
                voice_locale = voice.get('Locale', '')
                print(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å: {voice_name} ({voice_locale})")
                print(f"   üë© –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞: –ñ–ï–ù–°–ö–ò–ô ‚úì (Gender: {voice.get('Gender')})")
                return voice_name
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
        return None
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∂–µ–Ω—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞: {e}")
        return None

async def get_male_voice():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –º—É–∂—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞ –∏–∑ Edge TTS"""
    global _voices_cache
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
        if _voices_cache is None:
            voices = await edge_tts.list_voices()
            _voices_cache = voices
            
            # –í—ã–≤–æ–¥–∏–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ–ª–æ—Å–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
            if not hasattr(get_male_voice, '_voices_printed'):
                print("\n" + "="*60)
                print("üîä –î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã–µ –≥–æ–ª–æ—Å–∞ (Edge TTS):")
                male_count = 0
                for voice in voices:
                    gender = voice.get('Gender', 'Unknown')
                    locale = voice.get('Locale', 'Unknown')
                    name = voice.get('ShortName', 'Unknown')
                    if gender.lower() == 'male':
                        print(f"  üë§ {name} ({locale}) - {gender}")
                        male_count += 1
                print(f"–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –º—É–∂—Å–∫–∏—Ö –≥–æ–ª–æ—Å–æ–≤: {male_count}")
                print("="*60 + "\n")
                get_male_voice._voices_printed = True
        
        # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
        for preferred_voice in BACKUP_MALE_VOICES:
            for voice in _voices_cache:
                if voice.get('ShortName', '').lower() == preferred_voice.lower():
                    voice_gender = voice.get('Gender', '').lower()
                    voice_name = voice.get('ShortName', '')
                    voice_locale = voice.get('Locale', '')
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª –≥–æ–ª–æ—Å–∞
                    if voice_gender == 'male':
                        print(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å: {voice_name} ({voice_locale})")
                        print(f"   üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞: –ú–£–ñ–°–ö–û–ô ‚úì")
                        return voice_name
        
        # –ò—â–µ–º –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ä—É—Å—Å–∫–∏–π, –∑–∞—Ç–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
        preferred_locales = ['ru-RU', 'en-US', 'en-GB', 'ru']
        male_voice_names = ['dmitry', 'dmitri', 'pavel', 'guy', 'david', 'mark', 'james', 'ivan', 'ivanovich']
        
        # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ä—É—Å—Å–∫–∏–π –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –ø–æ –ª–æ–∫–∞–ª–∏
        for locale in preferred_locales:
            for voice in _voices_cache:
                voice_locale = voice.get('Locale', '')
                voice_name = voice.get('ShortName', '').lower()
                gender = voice.get('Gender', '').lower()
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å –∏ –ø–æ–ª
                if gender == 'male' and locale in voice_locale:
                    voice_short_name = voice.get('ShortName', '')
                    voice_full_locale = voice.get('Locale', '')
                    print(f"‚úÖ –ù–∞–π–¥–µ–Ω –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –ø–æ –ª–æ–∫–∞–ª–∏: {voice_short_name} ({voice_full_locale})")
                    print(f"   üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞: –ú–£–ñ–°–ö–û–ô ‚úì (Gender: {voice.get('Gender')})")
                    return voice_short_name
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –ª–æ–∫–∞–ª–∏, –∏—â–µ–º –ª—é–±–æ–π –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –ø–æ –∏–º–µ–Ω–∏
        for voice in _voices_cache:
            voice_name = voice.get('ShortName', '').lower()
            gender = voice.get('Gender', '').lower()
            
            if gender == 'male':
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è –≥–æ–ª–æ—Å–∞
                if any(male_name in voice_name for male_name in male_voice_names):
                    voice_short_name = voice.get('ShortName', '')
                    voice_full_locale = voice.get('Locale', '')
                    print(f"‚úÖ –ù–∞–π–¥–µ–Ω –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –ø–æ –∏–º–µ–Ω–∏: {voice_short_name} ({voice_full_locale})")
                    print(f"   üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞: –ú–£–ñ–°–ö–û–ô ‚úì (Gender: {voice.get('Gender')})")
                    return voice_short_name
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∏–º–µ–Ω–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å
        for voice in _voices_cache:
            gender = voice.get('Gender', '').lower()
            if gender == 'male':
                voice_name = voice.get('ShortName', '')
                voice_locale = voice.get('Locale', '')
                print(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å: {voice_name} ({voice_locale})")
                print(f"   üë§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞: –ú–£–ñ–°–ö–û–ô ‚úì (Gender: {voice.get('Gender')})")
                return voice_name
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π (–ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–º)
        if _voices_cache:
            first_voice = _voices_cache[0]
            first_voice_name = first_voice.get('ShortName', '')
            first_voice_gender = first_voice.get('Gender', 'Unknown')
            first_voice_locale = first_voice.get('Locale', '')
            
            print(f"‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –≥–æ–ª–æ—Å: {first_voice_name} ({first_voice_locale})")
            print(f"   ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞: {first_voice_gender.upper()}")
            if first_voice_gender.lower() != 'male':
                print(f"   ‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –ù–ï –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å! –ü–æ–ª: {first_voice_gender}")
                print(f"   üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç—å –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –≤ BACKUP_MALE_VOICES")
            return first_voice_name
        
        return None
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≥–æ–ª–æ—Å–∞: {e}")
        return None

async def generate_audio_file(text, personality_name=None):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ"""
    global _last_tts_time
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å API
    current_time = time.time()
    time_since_last = current_time - _last_tts_time
    if time_since_last < _min_tts_interval:
        wait_time = _min_tts_interval - time_since_last
        print(f"‚è≥ –ó–∞–¥–µ—Ä–∂–∫–∞ {wait_time:.2f} —Å–µ–∫ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º TTS...")
        await asyncio.sleep(wait_time)
    _last_tts_time = time.time()
    
    try:
        # –û—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç HTML-—Ç–µ–≥–æ–≤ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
        clean_text = re.sub(r'<[^>]+>', '', text)  # –£–¥–∞–ª—è–µ–º HTML-—Ç–µ–≥–∏
        # –ë–æ–ª–µ–µ –º—è–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ - –æ—Å—Ç–∞–≤–ª—è–µ–º –±–æ–ª—å—à–µ —Å–∏–º–≤–æ–ª–æ–≤
        clean_text = re.sub(r'[^\w\s\.,!?;:\-\(\)\u0400-\u04FF\u00C0-\u017F]', '', clean_text)
        
        if not clean_text.strip():
            print("‚ö†Ô∏è –¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏ –ø—É—Å—Ç –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏")
            return None
        
        print(f"üîä –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∞—É–¥–∏–æ –¥–ª—è —Ç–µ–∫—Å—Ç–∞: {clean_text[:50]}...")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
        personality_gender = await detect_personality_gender(personality_name)
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        # –ñ–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å —Ç–æ–ª—å–∫–æ –¥–ª—è —è–≤–Ω–æ –∂–µ–Ω—Å–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        if personality_gender == 'female':
            print(f"üë© –ü–µ—Ä—Å–æ–Ω–∞–∂ '{personality_name}' - –ñ–ï–ù–©–ò–ù–ê, –∏—Å–ø–æ–ª—å–∑—É—é –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å")
            voice_name = await get_female_voice()
            if not voice_name:
                print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å, –∏—Å–ø–æ–ª—å–∑—É—é –º—É–∂—Å–∫–æ–π")
                voice_name = await get_male_voice()
        else:
            # –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å
            print(f"üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂ '{personality_name if personality_name else '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}' - –ú–£–ñ–ß–ò–ù–ê, –∏—Å–ø–æ–ª—å–∑—É—é –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å")
            voice_name = await get_male_voice()
        
        if not voice_name:
            print("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≥–æ–ª–æ—Å –¥–ª—è –æ–∑–≤—É—á–∫–∏")
            return None
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞ –≥–æ–ª–æ—Å–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
        voice_info = None
        if _voices_cache:
            for v in _voices_cache:
                if v.get('ShortName', '').lower() == voice_name.lower():
                    voice_info = v
                    break
        
        if voice_info:
            voice_gender = voice_info.get('Gender', 'Unknown').lower()
            voice_locale = voice_info.get('Locale', 'Unknown')
            
            print(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ–ª–æ—Å: {voice_name} ({voice_locale})")
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∞ –≥–æ–ª–æ—Å–∞ (—Å —É—á–µ—Ç–æ–º –ø–æ–ª–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞)
            if voice_gender == 'male':
                if personality_gender == 'male':
                    print(f"   üë§ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ú–£–ñ–°–ö–û–ô –≥–æ–ª–æ—Å ‚úì (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂—É)")
                else:
                    print(f"   ‚ö†Ô∏è –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ú–£–ñ–°–ö–û–ô –≥–æ–ª–æ—Å, –Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ –ñ–ï–ù–©–ò–ù–ê!")
                    print(f"   üí° –ò—â—É –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å...")
                    # –ò—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å
                    alternative_female_voice = None
                    for v in _voices_cache:
                        if v.get('Gender', '').lower() == 'female':
                            alternative_female_voice = v.get('ShortName', '')
                            print(f"   ‚úÖ –ù–∞–π–¥–µ–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å: {alternative_female_voice}")
                            voice_name = alternative_female_voice
                            voice_info = v
                            break
                    if not alternative_female_voice:
                        print(f"   ‚ö†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∂–µ–Ω—Å–∫–∏–π –≥–æ–ª–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞—é —Å –º—É–∂—Å–∫–∏–º")
            elif voice_gender == 'female':
                if personality_gender == 'female':
                    print(f"   üë© –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ñ–ï–ù–°–ö–ò–ô –≥–æ–ª–æ—Å ‚úì (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂—É)")
                else:
                    print(f"   ‚ö†Ô∏è –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ñ–ï–ù–°–ö–ò–ô –≥–æ–ª–æ—Å, –Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ –ú–£–ñ–ß–ò–ù–ê!")
                    print(f"   üí° –ò—â—É –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å...")
                    # –ò—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å
                    alternative_male_voice = None
                    for v in _voices_cache:
                        if v.get('Gender', '').lower() == 'male':
                            alternative_male_voice = v.get('ShortName', '')
                            print(f"   ‚úÖ –ù–∞–π–¥–µ–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å: {alternative_male_voice}")
                            voice_name = alternative_male_voice
                            voice_info = v
                            break
                    if not alternative_male_voice:
                        print(f"   ‚ö†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º—É–∂—Å–∫–æ–π –≥–æ–ª–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞—é —Å –∂–µ–Ω—Å–∫–∏–º")
            else:
                print(f"   ‚ö†Ô∏è –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü–æ–ª –≥–æ–ª–æ—Å–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω ({voice_gender})")
        else:
            print(f"‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–æ–ª–æ—Å: {voice_name}")
            print(f"   ‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª–µ –≥–æ–ª–æ—Å–∞")
        
        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
        # –í edge_tts 4.0.11 –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ run() —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        communicate = edge_tts.Communicate()
        
        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        os.makedirs(AUDIO_DIR, exist_ok=True)
        
        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
        import hashlib
        timestamp = int(time.time())
        file_hash = hashlib.md5(f"{clean_text}_{voice_name}_{timestamp}".encode()).hexdigest()[:8]
        audio_filename = f"tts_{timestamp}_{file_hash}.mp3"
        audio_path = os.path.join(AUDIO_DIR, audio_filename)
        
        print(f"üìÅ –°–æ—Ö—Ä–∞–Ω—è—é –∞—É–¥–∏–æ –≤: {os.path.abspath(audio_path)}")
        
        # –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø—Ä–∏ –æ—à–∏–±–∫–µ 403
        max_retries = 1
        base_delay = 10  # –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        max_delay = 120  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
        for attempt in range(max_retries):
            try:
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞—É–¥–∏–æ
                if attempt > 0:
                    # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff —Å jitter (—Å–ª—É—á–∞–π–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–µ–π)
                    delay = min(base_delay * (2 ** (attempt - 1)), max_delay)
                    jitter = random.uniform(0.8, 1.2)  # ¬±20% —Å–ª—É—á–∞–π–Ω–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è
                    actual_delay = delay * jitter
                    print(f"üîÑ –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries} –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ...")
                    print(f"   ‚è≥ –ñ–¥—É {actual_delay:.1f} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
                    await asyncio.sleep(actual_delay)
                else:
                    print("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∞—É–¥–∏–æ...")
                
                # –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Communicate
                if attempt > 0:
                    communicate = edge_tts.Communicate()
                    print(f"   üîÑ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Communicate –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ {attempt + 1}")
                
                print(f"   üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ Edge TTS API...")
                print(f"   üé§ –ì–æ–ª–æ—Å: {voice_name}")
                print(f"   üìù –¢–µ–∫—Å—Ç (–ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤): {clean_text[:100]}...")
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ run() –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
                # run() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç async generator, –Ω—É–∂–Ω–æ –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
                async for chunk in communicate.run(
                    messages=clean_text,
                    voice=voice_name,
                    codec='audio-24khz-48kbitrate-mono-mp3',
                    pitch='+0Hz',
                    rate='+0%',
                    volume='+0%'
                ):
                    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π chunk –≤ —Ñ–∞–π–ª
                    with open(audio_path, 'ab') as f:
                        f.write(chunk)
                
                if not os.path.exists(audio_path):
                    print("‚ö†Ô∏è –§–∞–π–ª –∞—É–¥–∏–æ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω")
                    if attempt < max_retries - 1:
                        continue
                    return None
                
                print(f"‚úÖ –ê—É–¥–∏–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: {audio_filename}")
            
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ (–±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ /audio/filename.mp3)
                return audio_filename
                
            except Exception as e:
                        error_str = str(e)
                        is_403_error = '403' in error_str or 'WSServerHandshakeError' in error_str
                        is_network_error = 'Connection' in error_str or 'timeout' in error_str.lower()
                        
                        # –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è 403 –∏–ª–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
                        if (is_403_error or is_network_error) and attempt < max_retries - 1:
                            error_type = "403" if is_403_error else "—Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞"
                            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ {error_type} –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—É–¥–∏–æ (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries})")
                            print(f"   –î–µ—Ç–∞–ª–∏: {str(e)[:100]}...")
                            
                            # –î–ª—è –æ—à–∏–±–∫–∏ 403 –¥–æ–±–∞–≤–ª—è–µ–º –±–æ–ª–µ–µ –¥–ª–∏—Ç–µ–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                            if is_403_error:
                                extra_delay = 30  # 30 —Å–µ–∫—É–Ω–¥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è 403
                                print(f"   ‚è≥ –î–æ–±–∞–≤–ª—è—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É {extra_delay}—Å–µ–∫ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏...")
                                await asyncio.sleep(extra_delay)
                            
                            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
                            continue
                        else:
                            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞: {e}")
                        if attempt == max_retries - 1:
                                print("‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ Edge TTS –∏—Å—á–µ—Ä–ø–∞–Ω—ã.")
                                print("üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:")
                                print("   1. –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ IP - –ø–æ–¥–æ–∂–¥–∏—Ç–µ 10-15 –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π")
                                print("   2. –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VPN –∏–ª–∏ –ø—Ä–æ–∫—Å–∏")
                                print("   3. –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É")
                                print("   4. Edge TTS API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ")
                                print("   ‚ö†Ô∏è –ê—É–¥–∏–æ –Ω–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É")
                                if GTTS_AVAILABLE:
                                    print("üîÑ –ü—Ä–æ–±—É—é fallback —á–µ—Ä–µ–∑ gTTS...")
                                    try:
                                        gtts_result = await generate_audio_file_gtts(clean_text)
                                        if gtts_result:
                                            print("‚úÖ Fallback gTTS —Å—Ä–∞–±–æ—Ç–∞–ª")
                                            return gtts_result
                                        else:
                                            print("‚ö†Ô∏è gTTS fallback –Ω–µ —Å–æ–∑–¥–∞–ª –∞—É–¥–∏–æ")
                                    except Exception as gtts_error:
                                        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ gTTS fallback: {gtts_error}")
                                else:
                                    print("‚ÑπÔ∏è gTTS –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install gTTS")
                        import traceback
                        traceback.print_exc()
                        return None
                
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ: {e}")
        import traceback
        traceback.print_exc()
        # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ gTTS, –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ —É–ø–∞–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ
        if GTTS_AVAILABLE:
            try:
                print("üîÑ –ü—ã—Ç–∞—é—Å—å fallback —á–µ—Ä–µ–∑ gTTS –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏...")
                gtts_result = await generate_audio_file_gtts(text, None, None)
                if gtts_result:
                    print("‚úÖ Fallback gTTS —Å—Ä–∞–±–æ—Ç–∞–ª –ø–æ—Å–ª–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è")
                    return gtts_result
            except Exception as gtts_exc:
                print(f"‚ö†Ô∏è gTTS fallback —Ç–æ–∂–µ —É–ø–∞–ª: {gtts_exc}")
        return None


async def generate_audio_file_gtts(text, personality_gender=None, lang=None):
    """
    Fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ gTTS (–ª–æ–∫–∞–ª—å–Ω–æ, –±–µ–∑ Edge TTS).
    gTTS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª–∞ –≥–æ–ª–æ—Å–∞, –ø–æ—ç—Ç–æ–º—É –ø–æ–ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    if not GTTS_AVAILABLE:
        print("‚ÑπÔ∏è gTTS –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–º–æ–¥—É–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)")
        return None

    try:
        # –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç HTML –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        clean_text = re.sub(r'<[^>]+>', '', text)
        clean_text = re.sub(r'[^\w\s\.,!?;:\-\(\)\u0400-\u04FF\u00C0-\u017F]', '', clean_text)

        if not clean_text.strip():
            print("‚ö†Ô∏è –¢–µ–∫—Å—Ç –¥–ª—è –æ–∑–≤—É—á–∫–∏ –ø—É—Å—Ç –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ (gTTS)")
            return None

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫: –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ ‚Äî —Ä—É—Å—Å–∫–∏–π, –∏–Ω–∞—á–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
        if lang is None:
            has_cyrillic = bool(re.search(r'[–∞-—è–ê-–Ø]', clean_text))
            lang = 'ru' if has_cyrillic else 'en'

        # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (gTTS –Ω–µ –¥–∞—ë—Ç –≤—ã–±—Ä–∞—Ç—å –≥–æ–ª–æ—Å –ø–æ –ø–æ–ª—É)
        if personality_gender:
            print(f"‚ÑπÔ∏è gTTS fallback: –∂–µ–ª–∞–µ–º—ã–π –ø–æ–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: {personality_gender}")

        os.makedirs(AUDIO_DIR, exist_ok=True)

        timestamp = int(time.time())
        file_hash = hashlib.md5(f"{clean_text}_{lang}_{timestamp}".encode()).hexdigest()[:8]
        audio_filename = f"gtts_{timestamp}_{file_hash}.mp3"
        audio_path = os.path.join(AUDIO_DIR, audio_filename)

        loop = asyncio.get_event_loop()

        def save_sync():
            tts = gTTS(text=clean_text, lang=lang)
            tts.save(audio_path)

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å event loop
        await loop.run_in_executor(None, save_sync)

        if os.path.exists(audio_path):
            print(f"‚úÖ –ê—É–¥–∏–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ gTTS: {audio_filename}")
            return audio_filename
        else:
            print("‚ö†Ô∏è gTTS –Ω–µ —Å–æ–∑–¥–∞–ª —Ñ–∞–π–ª –∞—É–¥–∏–æ")
            return None

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ gTTS: {e}")
        import traceback
        traceback.print_exc()
        return None

# ========== API –†–û–£–¢–´ ==========
@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º (—á–∞—Ç —Å–ø—Ä–∞–≤–∞, –≤–∏–¥–µ–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É)"""
    if 'user_id' not in session:
        session['user_id'] = hashlib.md5(str(time.time()).encode()).hexdigest()[:10]
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if 'language' not in session:
        session['language'] = 'ru'
    
    lang = get_lang()
    user_data = donation_system.get_user_data(session['user_id'])
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–µ–π (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    update_personalities_background()
    
    # –ü–æ–ª—É—á–∞–µ–º –ª–∏—á–Ω–æ—Å—Ç–∏ –∏–∑ –∫—ç—à–∞ (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
    personalities = get_cached_personalities()
    
    # HTML –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–æ–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏ (—Ç–µ–ø–µ—Ä—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
    premium_section_html = ''
    
    # HTML –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –Ω–æ–≤—ã–º –¥–∏–∑–∞–π–Ω–æ–º
    t = lambda key, **kwargs: get_translation(key, lang, **kwargs)
    html = f'''
    <!DOCTYPE html>
    <html>
    <head>
        <title>{t('title')} —Å –ê–≤–∞—Ç–∞—Ä–æ–º</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/x-icon" href="/favicon.ico">
        <style>
            * {{
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }}
            
            body {{
                font-family: Arial, sans-serif;
                background: linear-gradient(135deg, #1a1a2e, #16213e);
                color: white;
                min-height: 100vh;
                overflow-x: hidden;
            }}
            
            .container {{
                max-width: 100%;
                width: 100%;
                margin: 0 auto;
                padding: 0 20px;
                box-sizing: border-box;
            }}
            
            .header {{
                text-align: center;
                margin-bottom: 30px;
                padding: 20px;
                background: rgba(255,255,255,0.1);
                border-radius: 15px;
                position: relative;
            }}
            
            .header h1 {{
                font-size: 36px;
                background: linear-gradient(45deg, #FFD700, #FFA500);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin: 0;
            }}
            
            .language-switcher {{
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                gap: 5px;
            }}
            
            .lang-btn {{
                padding: 5px 10px;
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 5px;
                color: white;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.3s;
            }}
            
            .lang-btn:hover {{
                background: rgba(255,255,255,0.3);
            }}
            
            .lang-btn.active {{
                background: linear-gradient(45deg, #FFD700, #FFA500);
                color: black;
                font-weight: bold;
            }}
            
            .user-info {{
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(255,255,255,0.1);
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 20px;
            }}
            
            .balance {{
                font-size: 24px;
                color: #FFD700;
                font-weight: bold;
            }}
            
            .premium-badge {{
                background: linear-gradient(45deg, #FFD700, #FFA500);
                color: black;
                padding: 8px 16px;
                border-radius: 20px;
                font-weight: bold;
            }}
            
            .content {{
                display: grid;
                grid-template-columns: 1fr 3fr;
                grid-template-rows: 1fr;
                gap: 20px;
                align-items: stretch;
                height: calc(100vh - 250px);
                min-height: calc(100vh - 250px);
            }}
            
            @media (max-width: 1200px) {{
                .content {{
                    grid-template-columns: 1fr;
                    grid-template-rows: auto;
                }}
            }}
            
            .sidebar {{
                background: rgba(255,255,255,0.1);
                padding: 20px;
                border-radius: 15px;
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                height: 100%;
            }}
            
            .personality-list {{
                flex: 1;
                overflow-y: auto;
                margin: 15px 0;
                min-height: 0;
            }}
            
            .personality-card {{
                background: rgba(255,255,255,0.1);
                padding: 15px;
                margin: 8px 0;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s;
            }}
            
            .personality-card:hover {{
                background: rgba(255,255,255,0.2);
                transform: translateY(-2px);
            }}
            
            .chat-area {{
                background: rgba(255,255,255,0.1);
                padding: 20px;
                border-radius: 15px;
                display: flex;
                flex-direction: column;
                height: 100%;
                min-height: 0;
            }}
            
            .chat-messages {{
                flex: 1;
                overflow-y: auto;
                padding: 10px;
                background: rgba(0,0,0,0.2);
                border-radius: 10px;
                margin-bottom: 15px;
            }}
            
            .message {{
                margin: 10px 0;
                padding: 12px;
                border-radius: 10px;
                max-width: 80%;
            }}
            
            .user-message {{
                background: rgba(102, 126, 234, 0.3);
                margin-left: auto;
                text-align: right;
            }}
            
            .bot-message {{
                background: rgba(255, 215, 0, 0.2);
                margin-right: auto;
            }}
            
            .input-area {{
                display: flex;
                gap: 10px;
            }}
            
            input[type="text"] {{
                flex: 1;
                padding: 12px;
                border: 2px solid #667eea;
                border-radius: 8px;
                background: rgba(255,255,255,0.1);
                color: white;
            }}
            
            button {{
                padding: 12px ;
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
            }}
            
            #voiceButton {{
                padding: 12px;
                min-width: 50px;
                background: linear-gradient(45deg, #667eea, #764ba2);
            }}
            
            #voiceButton.recording {{
                background: linear-gradient(45deg, #ff4757, #ff3838);
                animation: pulse 1.5s infinite;
            }}
            
            @keyframes pulse {{
                0%, 100% {{ opacity: 1; }}
                50% {{ opacity: 0.7; }}
            }}
            
            #voiceButton:disabled {{
                opacity: 0.5;
                cursor: not-allowed;
            }}
            
            .modal {{
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8);
                align-items: center;
                justify-content: center;
            }}
            
            .modal-content {{
                background: linear-gradient(135deg, #0f0c29, #302b63);
                padding: 30px;
                border-radius: 15px;
                border: 2px solid #FFD700;
                max-width: 500px;
                width: 90%;
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="language-switcher">
                    <button class="lang-btn {'active' if lang == 'ru' else ''}" onclick="changeLanguage('ru')" title="–†—É—Å—Å–∫–∏–π">RU</button>
                    <button class="lang-btn {'active' if lang == 'en' else ''}" onclick="changeLanguage('en')" title="English">EN</button>
                    <button class="lang-btn {'active' if lang == 'kk' else ''}" onclick="changeLanguage('kk')" title="“ö–∞–∑–∞“õ—à–∞">KK</button>
                </div>
                <h1>üé≠ {t('title')}</h1>
                <p>{t('subtitle')}</p>
            </div>
            
            
            <div class="content">
                <div class="sidebar">
                    <h3>üé≤ {t('free_personalities')}</h3>
                    <div id="personalityList" class="personality-list">
    '''
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –ª–∏—á–Ω–æ—Å—Ç–µ–π —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏
    for person in personalities:
        name = person[0]
        translated_name = translate_name(name, lang)  # –ü–µ—Ä–µ–≤–æ–¥–∏–º –∏–º—è
        role = translate_role(person[2], lang) if person[2] else ''
        period = person[3]  # –ü–µ—Ä–∏–æ–¥ –æ–±—ã—á–Ω–æ –Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è (–≥–æ–¥—ã)
        icon = person[4] if len(person) > 4 else 'üë§'
        
        html += f'''
        <div class="personality-card" onclick="startChat('{name}')">
            <strong>{icon} {translated_name}</strong><br>
            <small>{role} ({period})</small>
        </div>
        '''
    
    html += f'''
                    </div>
                    
                    <div id="premiumSection">
                        <h3>üëë {t('create_your_own')}</h3>
                        <input type="text" id="customPersonality" placeholder="{t('personality_name_placeholder')}" style="width: 90%; margin: 10px 0;">
                        <button onclick="createPersonality()" style="width: 100%;">{t('create_personality')}</button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button onclick="refreshPersonalities()" style="width: 48%;">üîÑ {t('refresh')}</button>
                        <button onclick="clearChat()" style="width: 48%; background: #dc3545;">üóëÔ∏è {t('clear')}</button>
                    </div>
                </div>
                
                <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å: —á–∞—Ç -->
                <div class="chat-area">
                    <div id="chatMessages" class="chat-messages">
                        <div class="message bot-message">
                            <strong>ü§ñ {t('bot_name')}:</strong><br>
                            {t('welcome_message')}
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <input type="text" id="messageInput" placeholder="{t('select_personality_placeholder')}" disabled>
                        <button id="voiceButton" onclick="toggleVoiceRecognition()" disabled title="{t('voice_input')}">üé§</button>
                        <button id="sendButton" onclick="sendMessage()" disabled>üì§ {t('send')}</button>
                    </div>
                </div>
            </div>
        </div>
        
        
        <script>
            // –ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è JavaScript
            const translations = {{
                'ru': {{
                    'ask_placeholder': '–°–ø—Ä–æ—Å–∏—Ç–µ —É {{name}}...',
                    'greeting': '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –Ø {{name}}. –û —á—ë–º —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?',
                    'balance': '–ë–∞–ª–∞–Ω—Å',
                    'currency': '—Ç–µ–Ω–≥–µ',
                    'premium': '–ü–†–ï–ú–ò–£–ú',
                    'donate': '–î–æ–Ω–∞—Ç',
                    'free_personalities': '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏',
                    'create_your_own': '–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é',
                    'create_personality': '–°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å',
                    'personality_name_placeholder': '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–∏—á–Ω–æ—Å—Ç–∏',
                    'refresh': '–û–±–Ω–æ–≤–∏—Ç—å',
                    'clear': '–û—á–∏—Å—Ç–∏—Ç—å',
                    'welcome_message': '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –ª–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞.',
                    'select_personality_placeholder': '–í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞...',
                    'send': '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
                    'voice_input': '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥',
                    'top_up_balance': '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å',
                    'current_balance': '–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å',
                    'premium_access': '–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø',
                    'premium_description': '–í–≤–æ–¥–∏—Ç–µ –ª—é–±—É—é –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –ª–∏—á–Ω–æ—Å—Ç—å',
                    'cost': '–°—Ç–æ–∏–º–æ—Å—Ç—å',
                    'unlock': '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å',
                    'bot_name': '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –±–æ—Ç',
                    'balance_added': '–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {{amount}} —Ç–µ–Ω–≥–µ',
                    'premium_unlocked': '–ü—Ä–µ–º–∏—É–º –¥–æ—Å—Ç—É–ø —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!',
                    'clear_chat_confirm': '–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?',
                    'clear_chat_message': '–ß–∞—Ç –æ—á–∏—â–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –ª–∏—á–Ω–æ—Å—Ç—å –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞.',
                    'top_up': '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å',
                    'close': '–ó–∞–∫—Ä—ã—Ç—å'
                }},
                'en': {{
                    'ask_placeholder': 'Ask {{name}}...',
                    'greeting': 'Greetings! I am {{name}}. What would you like to talk about?',
                    'balance': 'Balance',
                    'currency': 'tenge',
                    'premium': 'PREMIUM',
                    'donate': 'Donate',
                    'free_personalities': 'Free Personalities',
                    'create_your_own': 'Create Your Own',
                    'create_personality': 'Create Personality',
                    'personality_name_placeholder': 'Enter personality name',
                    'refresh': 'Refresh',
                    'clear': 'Clear',
                    'welcome_message': 'Welcome! Select a historical personality to start a dialogue.',
                    'select_personality_placeholder': 'Select a personality to start chat...',
                    'send': 'Send',
                    'voice_input': 'Voice Input',
                    'top_up_balance': 'Top Up Balance',
                    'current_balance': 'Current Balance',
                    'premium_access': 'Premium Access',
                    'premium_description': 'Enter any historical personality',
                    'cost': 'Cost',
                    'unlock': 'Unlock',
                    'bot_name': 'Historical Bot',
                    'balance_added': 'Balance topped up by {{amount}} tenge',
                    'premium_unlocked': 'Premium access unlocked!',
                    'clear_chat_confirm': 'Clear chat?',
                    'clear_chat_message': 'Chat cleared. Select a personality to start a dialogue.',
                    'top_up': 'Top Up Balance',
                    'close': 'Close'
                }},
                'kk': {{
                    'ask_placeholder': '{{name}} —Å“±—Ä–∞“£—ã–∑...',
                    'greeting': '–°”ô–ª–µ–º! –ú–µ–Ω {{name}}. –ù–µ —Ç—É—Ä–∞–ª—ã —Å”©–π–ª–µ—Å–µ–π—ñ–∫?',
                    'balance': '–ë–∞–ª–∞–Ω—Å',
                    'currency': '—Ç–µ“£–≥–µ',
                    'premium': '–ü–†–ï–ú–ò–£–ú',
                    'donate': '–î–æ–Ω–∞—Ç',
                    'free_personalities': '–¢–µ–≥—ñ–Ω —Ç“±–ª“ì–∞–ª–∞—Ä',
                    'create_your_own': '”®–∑ —Ç“±–ª“ì–∞“£—ã–∑–¥—ã –∂–∞—Å–∞“£—ã–∑',
                    'create_personality': '–¢“±–ª“ì–∞ –∂–∞—Å–∞—É',
                    'personality_name_placeholder': '–¢“±–ª“ì–∞ –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
                    'refresh': '–ñ–∞“£–∞—Ä—Ç—É',
                    'clear': '–¢–∞–∑–∞–ª–∞—É',
                    'welcome_message': '“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑! –î–∏–∞–ª–æ–≥—Ç—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω —Ç–∞—Ä–∏—Ö–∏ —Ç“±–ª“ì–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑.',
                    'select_personality_placeholder': '–ß–∞—Ç—Ç—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω —Ç“±–ª“ì–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑...',
                    'send': '–ñ—ñ–±–µ—Ä—É',
                    'voice_input': '–î–∞—É—ã—Å—Ç—ã“õ –µ–Ω–≥—ñ–∑—É',
                    'top_up_balance': '–ë–∞–ª–∞–Ω—Å—Ç—ã —Ç–æ–ª—Ç—ã—Ä—É',
                    'current_balance': '–ê“ì—ã–º–¥–∞“ì—ã –±–∞–ª–∞–Ω—Å',
                    'premium_access': '–ü—Ä–µ–º–∏—É–º “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ–ª—ñ–≥—ñ',
                    'premium_description': '–ö–µ–∑ –∫–µ–ª–≥–µ–Ω —Ç–∞—Ä–∏—Ö–∏ —Ç“±–ª“ì–∞–Ω—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
                    'cost': '–ë–∞“ì–∞—Å—ã',
                    'unlock': '–ê—à—É',
                    'bot_name': '–¢–∞—Ä–∏—Ö–∏ –±–æ—Ç',
                    'balance_added': '–ë–∞–ª–∞–Ω—Å {{amount}} —Ç–µ“£–≥–µ–≥–µ —Ç–æ–ª—Ç—ã—Ä—ã–ª–¥—ã',
                    'premium_unlocked': '–ü—Ä–µ–º–∏—É–º “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ–ª—ñ–≥—ñ –∞—à—ã–ª–¥—ã!',
                    'clear_chat_confirm': '–ß–∞—Ç—Ç—ã —Ç–∞–∑–∞–ª–∞—É –∫–µ—Ä–µ–∫ –ø–µ?',
                    'clear_chat_message': '–ß–∞—Ç —Ç–∞–∑–∞–ª–∞–Ω–¥—ã. –î–∏–∞–ª–æ–≥—Ç—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω —Ç“±–ª“ì–∞–Ω—ã —Ç–∞“£–¥–∞“£—ã–∑.',
                    'top_up': '–ë–∞–ª–∞–Ω—Å—Ç—ã —Ç–æ–ª—Ç—ã—Ä—É',
                    'close': '–ñ–∞–±—É'
                }}
            }};
            
            let currentLanguage = '{lang}';
            
            function t(key, params = {{}}) {{
                let text = translations[currentLanguage]?.[key] || translations['ru'][key] || key;
                if (params && Object.keys(params).length > 0) {{
                    Object.keys(params).forEach(k => {{
                        const doublePattern = '{{{{' + k + '}}}}';
                        const singlePattern = '{{' + k + '}}';
                        text = text.split(doublePattern).join(params[k]);
                        text = text.split(singlePattern).join(params[k]);
                    }});
                }}
                return text;
            }}
            
            // –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã —è–∑—ã–∫–∞
            async function changeLanguage(lang) {{
                try {{
                    const response = await fetch('/api/change_language', {{
                        method: 'POST',
                        headers: {{ 'Content-Type': 'application/json' }},
                        body: JSON.stringify({{ language: lang }})
                    }});
                    
                    const data = await response.json();
                    if (data.success) {{
                        currentLanguage = lang;
                        location.reload();
                    }}
                }} catch (error) {{
                    console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —è–∑—ã–∫–∞:', error);
                }}
            }}
            
            let currentChatId = null;
            let currentPersonality = null;
            let currentVideo = null;
            let currentAudio = null;
            let isVideoPlaying = false;
            
            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –≤—Å–µ—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
            const universalVideoUrl = '/video/neyro3.mp4';
            
            // –°—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –ª–∏—á–Ω–æ—Å—Ç–µ–π (–∫–∞–∫ fallback)
            const personalityImages = {{
                '–ü—ë—Ç—Ä I': 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Peter_der-Grosse_1838.jpg/300px-Peter_der-Grosse_1838.jpg',
                '–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ II': 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/CatherineIIbyLampi.jpg/300px-CatherineIIbyLampi.jpg',
                '–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/50/Jacques-Louis_David_-_The_UQDgwqVE-6aMBLYLbQv6i5N5y7bC5SajqSjHPzt8UJUqbZ8a_Google_Art_Project.jpg/300px-Jacques-Louis_David_-_The_UQDgwqVE-6aMBLYLbQv6i5N5y7bC5SajqSjHPzt8UJUqbZ8a_Google_Art_Project.jpg',
                '–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏': 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Leonardo_self.jpg/300px-Leonardo_self.jpg',
                '–ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Einstein_1921_by_F_Schmutzer_-_restoration.jpg/300px-Einstein_1921_by_F_Schmutzer_-_restoration.jpg',
                'default': 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/Einstein_1921_by_F_Schmutzer_-_restoration.jpg/300px-Einstein_1921_by_F_Schmutzer_-_restoration.jpg'
            }};
            
            // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
            let recognition = null;
            let isRecording = false;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
            function initSpeechRecognition() {{
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {{
                    console.warn('‚ö†Ô∏è Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                    const voiceButton = document.getElementById('voiceButton');
                    if (voiceButton) {{
                        voiceButton.style.display = 'none';
                    }}
                    return;
                }}
                
                recognition = new SpeechRecognition();
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                const langMap = {{'ru': 'ru-RU', 'en': 'en-US', 'kk': 'kk-KZ'}};
                recognition.lang = langMap[currentLanguage] || 'ru-RU';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => {{
                    console.log('üé§ –ù–∞—á–∞–ª–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏...');
                    isRecording = true;
                    const voiceButton = document.getElementById('voiceButton');
                    if (voiceButton) {{
                        voiceButton.classList.add('recording');
                        voiceButton.textContent = 'üî¥';
                    }}
                }};
                
                recognition.onresult = (event) => {{
                    const transcript = event.results[0][0].transcript;
                    console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:', transcript);
                    
                    const input = document.getElementById('messageInput');
                    if (input) {{
                        input.value = (input.value + ' ' + transcript).trim();
                        input.focus();
                    }}
                }};
                
                recognition.onerror = (event) => {{
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏:', event.error);
                    let errorMsg = '–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏';
                    if (event.error === 'no-speech') {{
                        errorMsg = '–†–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                    }} else if (event.error === 'not-allowed') {{
                        errorMsg = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                    }}
                    alert(errorMsg);
                    stopVoiceRecognition();
                }};
                
                recognition.onend = () => {{
                    console.log('üé§ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                    stopVoiceRecognition();
                }};
            }}
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
            function toggleVoiceRecognition() {{
                if (!recognition) {{
                    alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                    return;
                }}
                
                if (isRecording) {{
                    stopVoiceRecognition();
                }} else {{
                    startVoiceRecognition();
                }}
            }}
            
            function startVoiceRecognition() {{
                if (!recognition || isRecording) return;
                
                try {{
                    recognition.start();
                }} catch (error) {{
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                    if (error.message.includes('already started')) {{
                        stopVoiceRecognition();
                        setTimeout(() => startVoiceRecognition(), 100);
                    }}
                }}
            }}
            
            function stopVoiceRecognition() {{
                if (recognition && isRecording) {{
                    try {{
                        recognition.stop();
                    }} catch (error) {{
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                    }}
                }}
                
                isRecording = false;
                const voiceButton = document.getElementById('voiceButton');
                if (voiceButton) {{
                    voiceButton.classList.remove('recording');
                    voiceButton.textContent = 'üé§';
                }}
            }}
            
            // –ù–∞—á–∞–ª–æ —á–∞—Ç–∞
            async function startChat(personalityName) {{
                // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–µ –∏–º—è
                const nameResponse = await fetch('/api/translate_name', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{name: personalityName}})
                }});
                const nameData = await nameResponse.json();
                const translatedName = nameData.translated_name || personalityName;
                
                const response = await fetch('/api/start_chat', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{
                        personality_name: personalityName,
                        is_custom: false
                    }})
                }});
                
                const data = await response.json();
                if (data.success) {{
                    currentChatId = data.chat_id;
                    currentPersonality = data.personality;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendButton').disabled = false;
                    const voiceButton = document.getElementById('voiceButton');
                    if (voiceButton) voiceButton.disabled = false;
                    document.getElementById('messageInput').placeholder = t('ask_placeholder', {{name: translatedName}});
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
                    addMessage(`${{data.personality.icon}} <strong>${{translatedName}}:</strong><br>${{t('greeting', {{name: translatedName}})}}`, 'bot');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –¥–ª—è –ª–∏—á–Ω–æ—Å—Ç–∏ (–±–µ–∑ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞)
                    loadPersonalityVideo(personalityName);
                }}
            }}
            
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ
            function playAudioInBrowser(audioUrl) {{
                if (!audioUrl) {{
                    console.log('‚ö†Ô∏è URL –∞—É–¥–∏–æ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
                    return;
                }}
                
                console.log('üéµ –ù–∞—á–∏–Ω–∞—é –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ:', audioUrl);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∞—É–¥–∏–æ
                if (currentAudio) {{
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                }}
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –∞—É–¥–∏–æ
                const audio = new Audio(audioUrl);
                currentAudio = audio;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞—É–¥–∏–æ
                audio.addEventListener('error', (e) => {{
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', e);
                    console.error('URL:', audioUrl);
                    console.error('–ö–æ–¥ –æ—à–∏–±–∫–∏:', audio.error ? audio.error.code : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
                    showAudioPlayButton(audioUrl, audio);
                }});
                
                // –°–æ–±—ã—Ç–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—É–¥–∏–æ
                audio.addEventListener('ended', () => {{
                    console.log('‚úÖ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                    
                    // –û—á–∏—â–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∞—É–¥–∏–æ
                    currentAudio = null;
                    
                    // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –ø–æ—Å–ª–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                    setTimeout(() => {{
                        const filename = audioUrl.split('/').pop();
                        console.log('üóëÔ∏è –£–¥–∞–ª—è—é –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª:', filename);
                        fetch(`/api/delete_audio?file=${{filename}}`, {{ method: 'POST' }})
                            .then(res => res.json())
                            .then(data => {{
                                if (data.success) {{
                                    console.log('üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω:', filename);
                                }} else {{
                                    console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª:', data.error);
                                }}
                            }})
                            .catch(err => console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', err));
                    }}, 2000);
                }});
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞—É–¥–∏–æ
                audio.load();
                audio.play().catch(e => {{
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e);
                    showAudioPlayButton(audioUrl, audio);
                }});
            }}
            
            // –ü–æ–∫–∞–∑ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            function showAudioPlayButton(audioUrl, audio) {{
                const container = document.getElementById('chatMessages');
                const lastMessage = container.lastElementChild;
                if (lastMessage) {{
                    const playButton = document.createElement('button');
                    playButton.textContent = 'üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ—Ç–≤–µ—Ç';
                    playButton.style.cssText = 'margin-top: 10px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;';
                    playButton.onclick = () => {{
                        audio.play();
                        playButton.remove();
                    }};
                    lastMessage.appendChild(playButton);
                }}
            }}
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            async function sendMessage() {{
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message || !currentChatId || !currentPersonality) return;
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –æ—Ç–≤–µ—Ç–æ–º
                if (currentAudio) {{
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                }}
                
                addMessage(`<strong>–í—ã:</strong><br>${{message}}`, 'user');
                input.value = '';
                
                const response = await fetch('/api/send_message', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{
                        chat_id: currentChatId,
                        message: message,
                        personality_name: currentPersonality.name,
                        system_prompt: currentPersonality.system_prompt,
                        personality_period: currentPersonality.period || null
                    }})
                }});
                
                const data = await response.json();
                console.log('ÔøΩ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.success) {{
                    // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω–æ–µ –∏–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const nameResponse = await fetch('/api/translate_name', {{
                        method: 'POST',
                        headers: {{'Content-Type': 'application/json'}},
                        body: JSON.stringify({{name: currentPersonality.name}})
                    }});
                    const nameData = await nameResponse.json();
                    const translatedName = nameData.translated_name || currentPersonality.name;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç —Å –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
                    addMessage(`${{currentPersonality.icon}} <strong>${{translatedName}}:</strong><br>${{data.response}}`, 'bot');
                    
                    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞—É–¥–∏–æ
                    if (data.audio_url) {{
                        console.log('üéµ URL –∞—É–¥–∏–æ –ø–æ–ª—É—á–µ–Ω:', data.audio_url);
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
                        setTimeout(() => {{
                            playAudioInBrowser(data.audio_url);
                        }}, 150);
                    }} else {{
                        console.log('‚ö†Ô∏è audio_url –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ');
                    }}
                }} else {{
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                }}
            }}
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
            function addMessage(content, type) {{
                const container = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${{type}}-message`;
                messageDiv.innerHTML = content;
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            }}
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏
            async function createPersonality() {{
                const input = document.getElementById('customPersonality');
                const name = input.value.trim();
                
                if (!name) {{
                    const alertMsg = currentLanguage === 'ru' ? '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–∏—á–Ω–æ—Å—Ç–∏' :
                                    currentLanguage === 'en' ? 'Enter personality name' :
                                    '–¢“±–ª“ì–∞ –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑';
                    alert(alertMsg);
                    return;
                }}
                
                const response = await fetch('/api/create_custom_personality', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{ name: name }})
                }});
                
                const data = await response.json();
                if (data.success) {{
                    startChat(name);
                    input.value = '';
                }} else {{
                    alert(data.error);
                }}
            }}
            
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
            function refreshPersonalities() {{
                location.reload();
            }}
            
            function clearChat() {{
                if (confirm(t('clear_chat_confirm'))) {{
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="message bot-message">
                            <strong>ü§ñ ${{t('bot_name')}}:</strong><br>
                            ${{t('clear_chat_message')}}
                        </div>
                    `;
                }}
            }}
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            if (document.readyState === 'loading') {{
                document.addEventListener('DOMContentLoaded', initSpeechRecognition);
            }} else {{
                initSpeechRecognition();
            }}
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('messageInput').addEventListener('keypress', (e) => {{
                if (e.key === 'Enter') sendMessage();
            }});
        </script>
    </body>
    </html>
    '''
    
    return html

# –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...

@app.route('/favicon.ico')
def favicon():
    """–û—Ç–¥–∞—á–∞ favicon.ico"""
    try:
        return send_from_directory(os.path.dirname(os.path.abspath(__file__)), 'favicon.ico', mimetype='image/vnd.microsoft.icon')
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–¥–∞—á–µ favicon: {e}")
        return '', 404

@app.route('/api/ngrok_url')
def get_ngrok_url():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ Ngrok URL"""
    try:
        # –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ —Ñ–∞–π–ª–∞
        try:
            with open('ngrok_url.txt', 'r') as f:
                url = f.read().strip()
                return jsonify({'url': url})
        except:
            return jsonify({'url': 'http://localhost:5000'})
    except:
        return jsonify({'url': 'http://localhost:5000'})

@app.route('/audio/<filename>')
def serve_audio(filename):
    """–û—Ç–¥–∞—á–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤"""
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å
        audio_dir = os.path.abspath(AUDIO_DIR)
        file_path = os.path.join(audio_dir, filename)
        
        print(f"üì• –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–¥–∞—á—É –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞: {filename}")
        print(f"üìÅ AUDIO_DIR: {AUDIO_DIR}")
        print(f"üìÅ –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ: {audio_dir}")
        print(f"üìÅ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: {file_path}")
        
        if os.path.exists(file_path):
            file_size = os.path.getsize(file_path)
            print(f"‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω, —Ä–∞–∑–º–µ—Ä: {file_size} –±–∞–π—Ç")
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º send_from_directory —Å –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –ø—É—Ç–µ–º
            return send_from_directory(audio_dir, filename, mimetype='audio/mpeg')
        else:
            print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–∞–ø–∫–µ
            if os.path.exists(audio_dir):
                files_in_dir = os.listdir(audio_dir)
                print(f"üìÇ –§–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ {audio_dir}: {files_in_dir}")
            else:
                print(f"‚ùå –ü–∞–ø–∫–∞ {audio_dir} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
            return jsonify({'error': 'File not found'}), 404
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–¥–∞—á–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞ {filename}: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

@app.route('/video/<filename>')
def serve_video(filename):
    """–û—Ç–¥–∞—á–∞ –≤–∏–¥–µ–æ —Ñ–∞–π–ª–æ–≤"""
    try:
        # –ü—É—Ç—å –∫ –∫–æ—Ä–Ω—é –ø—Ä–æ–µ–∫—Ç–∞
        base_dir = os.path.dirname(os.path.abspath(__file__))
        file_path = os.path.join(base_dir, filename)
        
        print(f"üì• –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–¥–∞—á—É –≤–∏–¥–µ–æ —Ñ–∞–π–ª–∞: {filename}")
        print(f"üìÅ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: {file_path}")
        
        if os.path.exists(file_path):
            file_size = os.path.getsize(file_path)
            print(f"‚úÖ –í–∏–¥–µ–æ —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω, —Ä–∞–∑–º–µ—Ä: {file_size} –±–∞–π—Ç")
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            mimetype = 'video/mp4' if filename.endswith('.mp4') else 'video/webm'
            return send_from_directory(base_dir, filename, mimetype=mimetype)
        else:
            print(f"‚ùå –í–∏–¥–µ–æ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
            return jsonify({'error': 'Video file not found'}), 404
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–¥–∞—á–µ –≤–∏–¥–µ–æ —Ñ–∞–π–ª–∞ {filename}: {e}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500

@app.route('/api/delete_audio', methods=['POST'])
def delete_audio():
    """–£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ —Ñ–∞–π–ª–∞"""
    try:
        filename = request.args.get('file')
        if filename:
            file_path = os.path.join(AUDIO_DIR, filename)
            if os.path.exists(file_path):
                os.remove(file_path)
                print(f"üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω: {filename}")
                return jsonify({'success': True})
        return jsonify({'success': False, 'error': 'File not found'})
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/start_chat', methods=['POST'])
def start_chat_api():
    if 'user_id' not in session:
        return jsonify({'error': 'Not authenticated'}), 401
    
    data = request.json
    personality_name = data.get('personality_name')
    
    # –°–æ–∑–¥–∞–µ–º —á–∞—Ç
    cursor = db_conn.cursor()
    cursor.execute('INSERT INTO chats (user_id, personality_id) VALUES (?, (SELECT id FROM personalities WHERE name = ? LIMIT 1))', 
                  (session['user_id'], personality_name))
    chat_id = cursor.lastrowid
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ª–∏—á–Ω–æ—Å—Ç–∏
    cursor.execute('SELECT system_prompt, icon, period FROM personalities WHERE name = ? LIMIT 1', (personality_name,))
    result = cursor.fetchone()
    
    personality_data = {
        'name': personality_name,
        'system_prompt': result[0] if result else f'–¢—ã {personality_name}.',
        'icon': result[1] if result else 'üë§',
        'period': result[2] if result and len(result) > 2 else None
    }
    
    db_conn.commit()
    
    return jsonify({
        'success': True,
        'chat_id': chat_id,
        'personality': personality_data
    })

@app.route('/api/send_message', methods=['POST'])
def send_message_api():
    if 'user_id' not in session:
        return jsonify({'error': 'Not authenticated'}), 401
    
    data = request.json
    chat_id = data.get('chat_id')
    message = data.get('message')
    system_prompt = data.get('system_prompt')
    personality_name = data.get('personality_name')
    personality_period = data.get('personality_period')  # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–∏–æ–¥ –∏–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
    
    # –ï—Å–ª–∏ –ø–µ—Ä–∏–æ–¥ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø–æ–ª—É—á–∞–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    if not personality_period:
        cursor = db_conn.cursor()
        cursor.execute('SELECT period FROM personalities WHERE name = ? LIMIT 1', (personality_name,))
        result = cursor.fetchone()
        if result:
            personality_period = result[0]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor = db_conn.cursor()
    cursor.execute('INSERT INTO messages (chat_id, is_user, content) VALUES (?, 1, ?)', (chat_id, message))
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    cursor.execute('UPDATE chats SET last_message_at = CURRENT_TIMESTAMP WHERE id = ?', (chat_id,))
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò —Å —É—á–µ—Ç–æ–º –ø–µ—Ä–∏–æ–¥–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
    ai_response = asyncio.run(get_ai_response(system_prompt, message, personality_period))
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò
    cursor.execute('INSERT INTO messages (chat_id, is_user, content) VALUES (?, 0, ?)', (chat_id, ai_response))
    
    db_conn.commit()
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞—É–¥–∏–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
    audio_filename = None
    audio_url = None
    try:
        print(f"üéµ –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∞—É–¥–∏–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –¥–ª–∏–Ω–æ–π {len(ai_response)} —Å–∏–º–≤–æ–ª–æ–≤...")
        audio_filename = asyncio.run(generate_audio_file(ai_response, personality_name))
        if audio_filename:
            audio_url = f'/audio/{audio_filename}'
            print(f"‚úÖ –ê—É–¥–∏–æ —Ñ–∞–π–ª –≥–æ—Ç–æ–≤: {audio_filename}")
            print(f"‚úÖ URL –∞—É–¥–∏–æ: {audio_url}")
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            audio_path = os.path.join(AUDIO_DIR, audio_filename)
            if os.path.exists(audio_path):
                file_size = os.path.getsize(audio_path)
                print(f"‚úÖ –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Ä–∞–∑–º–µ—Ä: {file_size} –±–∞–π—Ç")
            else:
                print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {audio_path}")
        else:
            print("‚ö†Ô∏è audio_filename = None, –∞—É–¥–∏–æ –Ω–µ –±—ã–ª–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏–æ: {e}")
        import traceback
        traceback.print_exc()
    
    response_data = {
        'success': True,
        'response': ai_response,
        'audio_url': audio_url
    }
    print(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –æ—Ç–≤–µ—Ç —Å audio_url: {audio_url}")
    return jsonify(response_data)

# API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –¥–æ–Ω–∞—Ç–∞ –∏ –ø—Ä–µ–º–∏—É–º–∞ —É–¥–∞–ª–µ–Ω—ã - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã

@app.route('/api/change_language', methods=['POST'])
def change_language_api():
    """–ò–∑–º–µ–Ω–µ–Ω–∏–µ —è–∑—ã–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
    if 'user_id' not in session:
        return jsonify({'error': 'Not authenticated'}), 401
    
    data = request.json
    lang = data.get('language', 'ru')
    
    if lang not in TRANSLATIONS:
        lang = 'ru'
    
    session['language'] = lang
    return jsonify({'success': True, 'language': lang})

async def generate_personality_info(personality_name, lang='ru'):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏—á–Ω–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏"""
    try:
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞
        if lang == 'en':
            prompt = f"""For the historical personality "{personality_name}" create information in the following JSON format:
{{
    "era": "era (russian, modern, renaissance, antiquity, middle_ages, custom)",
    "role": "role/title in English (e.g.: Emperor of All Russia, King of France, Philosopher)",
    "period": "years of life (e.g.: 1672-1725, 100-44 BC)",
    "icon": "one emoji suitable for this personality (e.g.: üëë, ‚öîÔ∏è, üé®)",
    "system_prompt": "AI prompt in format 'You are [name], who lived in [period]. You only know about events before [death year]. [character description]. If asked about events after [death year] - express confusion.'"
}}

Examples:
- "Peter I" ‚Üí {{"era": "russian", "role": "Emperor of All Russia", "period": "1672-1725", "icon": "üëë", "system_prompt": "You are Peter I the Great, who lived in 1672-1725. You only know about events before 1725. Speak roughly, directly, like a man of action. If asked about events after 1725 - express confusion."}}
- "Napoleon Bonaparte" ‚Üí {{"era": "modern", "role": "Emperor of France", "period": "1769-1821", "icon": "üéñÔ∏è", "system_prompt": "You are Napoleon I, who lived in 1769-1821. You only know about events before 1821. Speak ambitiously, authoritatively. If asked about events after 1821 - express confusion."}}
- "Cleopatra" ‚Üí {{"era": "antiquity", "role": "Queen of Egypt", "period": "69-30 BC", "icon": "üëë", "system_prompt": "You are Cleopatra VII, who lived in 69-30 BC. You only know about events before 30 BC. Speak wisely, seductively, authoritatively. If asked about events after your time - express confusion."}}

Answer ONLY with valid JSON without additional comments:"""
        elif lang == 'kk':
            prompt = f"""–¢–∞—Ä–∏—Ö–∏ —Ç“±–ª“ì–∞ "{personality_name}" “Ø—à—ñ–Ω –∫–µ–ª–µ—Å—ñ JSON —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞ –∞“õ–ø–∞—Ä–∞—Ç –∂–∞—Å–∞“£—ã–∑:
{{
    "era": "–¥”ô—É—ñ—Ä (russian, modern, renaissance, antiquity, middle_ages, custom)",
    "role": "—Ä”©–ª/—Ç–∏—Ç—É–ª “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ (–º—ã—Å–∞–ª—ã: –ë“Ø–∫—ñ–ª –†–µ—Å–µ–π –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã, –§—Ä–∞–Ω—Ü–∏—è –ø–∞—Ç—à–∞—Å—ã, –§–∏–ª–æ—Å–æ—Ñ)",
    "period": "”©–º—ñ—Ä —Å“Ø—Ä–≥–µ–Ω –∂—ã–ª–¥–∞—Ä (–º—ã—Å–∞–ª—ã: 1672-1725, –±.–∑.–¥. 100-44)",
    "icon": "–±“±–ª —Ç“±–ª“ì–∞“ì–∞ —Å–∞–π –±—ñ—Ä —ç–º–æ–¥–∑–∏ (–º—ã—Å–∞–ª—ã: üëë, ‚öîÔ∏è, üé®)",
    "system_prompt": "–ò–ò “Ø—à—ñ–Ω –ø—Ä–æ–º–ø—Ç '[–∞—Ç–∞—É], [–∫–µ–∑–µ“£]–¥–µ ”©–º—ñ—Ä —Å“Ø—Ä–≥–µ–Ω. –°–µ–Ω —Ç–µ–∫ [”©–ª—ñ–º –∂—ã–ª—ã] –∂—ã–ª“ì–∞ –¥–µ–π—ñ–Ω–≥—ñ –æ“õ–∏“ì–∞–ª–∞—Ä–¥—ã –±—ñ–ª–µ—Å—ñ“£. [–º—ñ–Ω–µ–∑ —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã]. –ï–≥–µ—Ä [”©–ª—ñ–º –∂—ã–ª—ã] –∂—ã–ª—ã–Ω–∞–Ω –∫–µ–π—ñ–Ω–≥—ñ –æ“õ–∏“ì–∞–ª–∞—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞—Å—Å–∞ - —Ç“Ø—Å—ñ–Ω–±–µ—É—à—ñ–ª—ñ–∫ –±—ñ–ª–¥—ñ—Ä.' —Ñ–æ—Ä–º–∞—Ç—ã–Ω–¥–∞"
}}

–ú—ã—Å–∞–ª–¥–∞—Ä:
- "I –ü–µ—Ç—Ä" ‚Üí {{"era": "russian", "role": "–ë“Ø–∫—ñ–ª –†–µ—Å–µ–π –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã", "period": "1672-1725", "icon": "üëë", "system_prompt": "–°–µ–Ω I –ü–µ—Ç—Ä “∞–ª—ã, 1672-1725 –∂—ã–ª–¥–∞—Ä—ã ”©–º—ñ—Ä —Å“Ø—Ä–≥–µ–Ω. –°–µ–Ω —Ç–µ–∫ 1725 –∂—ã–ª“ì–∞ –¥–µ–π—ñ–Ω–≥—ñ –æ“õ–∏“ì–∞–ª–∞—Ä–¥—ã –±—ñ–ª–µ—Å—ñ“£. “ö–∞—Ç–∞–ª, —Ç—ñ–∫–µ–ª–µ–π, —ñ—Å –∞–¥–∞–º—ã–Ω–¥–∞–π —Å”©–π–ª–µ. –ï–≥–µ—Ä 1725 –∂—ã–ª—ã–Ω–∞–Ω –∫–µ–π—ñ–Ω–≥—ñ –æ“õ–∏“ì–∞–ª–∞—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞—Å—Å–∞ - —Ç“Ø—Å—ñ–Ω–±–µ—É—à—ñ–ª—ñ–∫ –±—ñ–ª–¥—ñ—Ä."}}
- "–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç" ‚Üí {{"era": "modern", "role": "–§—Ä–∞–Ω—Ü–∏—è –∏–º–ø–µ—Ä–∞—Ç–æ—Ä—ã", "period": "1769-1821", "icon": "üéñÔ∏è", "system_prompt": "–°–µ–Ω I –ù–∞–ø–æ–ª–µ–æ–Ω, 1769-1821 –∂—ã–ª–¥–∞—Ä—ã ”©–º—ñ—Ä —Å“Ø—Ä–≥–µ–Ω. –°–µ–Ω —Ç–µ–∫ 1821 –∂—ã–ª“ì–∞ –¥–µ–π—ñ–Ω–≥—ñ –æ“õ–∏“ì–∞–ª–∞—Ä–¥—ã –±—ñ–ª–µ—Å—ñ“£. –ê–º–±–∏—Ü–∏—è–ª—ã, –±–∏–ª—ñ–∫—Ç—ñ —Å”©–π–ª–µ. –ï–≥–µ—Ä 1821 –∂—ã–ª—ã–Ω–∞–Ω –∫–µ–π—ñ–Ω–≥—ñ –æ“õ–∏“ì–∞–ª–∞—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞—Å—Å–∞ - —Ç“Ø—Å—ñ–Ω–±–µ—É—à—ñ–ª—ñ–∫ –±—ñ–ª–¥—ñ—Ä."}}

–¢–µ–∫ –≤–∞–ª–∏–¥—Ç—ñ JSON –∂–∞—É–∞–ø –±–µ—Ä—ñ“£—ñ–∑, “õ–æ—Å—ã–º—à–∞ —Ç“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ–ª–µ—Ä—Å—ñ–∑:"""
        else:  # ru
            prompt = f"""–î–ª—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ "{personality_name}" —Å–æ–∑–¥–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
    "era": "—ç–ø–æ—Ö–∞ (russian, modern, renaissance, antiquity, middle_ages, custom)",
    "role": "—Ä–æ–ª—å/—Ç–∏—Ç—É–ª –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–º–ø–µ—Ä–∞—Ç–æ—Ä –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π, –ö–æ—Ä–æ–ª—å –§—Ä–∞–Ω—Ü–∏–∏, –§–∏–ª–æ—Å–æ—Ñ)",
    "period": "–≥–æ–¥—ã –∂–∏–∑–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1672-1725, 100-44 –¥–æ –Ω.—ç.)",
    "icon": "–æ–¥–∏–Ω —ç–º–æ–¥–∑–∏, –ø–æ–¥—Ö–æ–¥—è—â–∏–π –¥–ª—è —ç—Ç–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: üëë, ‚öîÔ∏è, üé®)",
    "system_prompt": "–ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò –≤ —Ñ–æ—Ä–º–∞—Ç–µ '–¢—ã [–∏–º—è], –∂–∏–≤—à–∏–π –≤ [–ø–µ—Ä–∏–æ–¥]. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ [–≥–æ–¥ —Å–º–µ—Ä—Ç–∏] –≥–æ–¥–∞. [–æ–ø–∏—Å–∞–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞]. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ [–≥–æ–¥ —Å–º–µ—Ä—Ç–∏] –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ.'"
}}

–ü—Ä–∏–º–µ—Ä—ã:
- "–ü—ë—Ç—Ä I" ‚Üí {{"era": "russian", "role": "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –í—Å–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π", "period": "1672-1725", "icon": "üëë", "system_prompt": "–¢—ã –ü—ë—Ç—Ä I –í–µ–ª–∏–∫–∏–π, –∂–∏–≤—à–∏–π –≤ 1672-1725 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1725 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –≥—Ä—É–±–æ, –ø—Ä—è–º–æ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –¥–µ–ª–∞. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1725 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ."}}
- "–ù–∞–ø–æ–ª–µ–æ–Ω –ë–æ–Ω–∞–ø–∞—Ä—Ç" ‚Üí {{"era": "modern", "role": "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä –§—Ä–∞–Ω—Ü–∏–∏", "period": "1769-1821", "icon": "üéñÔ∏è", "system_prompt": "–¢—ã –ù–∞–ø–æ–ª–µ–æ–Ω I, –∂–∏–≤—à–∏–π –≤ 1769-1821 –≥–æ–¥–∞—Ö. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 1821 –≥–æ–¥–∞. –ì–æ–≤–æ—Ä–∏ –∞–º–±–∏—Ü–∏–æ–∑–Ω–æ, –≤–ª–∞—Å—Ç–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ 1821 –≥–æ–¥–∞ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ."}}
- "–ö–ª–µ–æ–ø–∞—Ç—Ä–∞" ‚Üí {{"era": "antiquity", "role": "–¶–∞—Ä–∏—Ü–∞ –ï–≥–∏–ø—Ç–∞", "period": "69-30 –¥–æ –Ω.—ç.", "icon": "üëë", "system_prompt": "–¢—ã –ö–ª–µ–æ–ø–∞—Ç—Ä–∞ VII, –∂–∏–≤—à–∞—è –≤ 69-30 –≥–æ–¥–∞—Ö –¥–æ –Ω.—ç. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö –¥–æ 30 –≥–æ–¥–∞ –¥–æ –Ω.—ç. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ, —Å–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–æ, –≤–ª–∞—Å—Ç–Ω–æ. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ."}}

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:"""
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
        available_models = []
        for attr in dir(g4f.models):
            if not attr.startswith('_'):
                available_models.append(attr)
        
        # –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å
        model_to_use = None
        preferred_models = ['gpt_35_turbo', 'default', 'gpt_4', 'gpt_4_turbo']
        
        for model_name in preferred_models:
            if hasattr(g4f.models, model_name):
                model_to_use = getattr(g4f.models, model_name)
                break
        
        if model_to_use is None and available_models:
            model_to_use = getattr(g4f.models, available_models[0])
        
        if model_to_use:
            response = await g4f.ChatCompletion.create_async(
                model=model_to_use,
                messages=[
                    {"role": "system", "content": "–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –ª–∏—á–Ω–æ—Å—Ç—è—Ö. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–º JSON."},
                    {"role": "user", "content": prompt}
                ],
                temperature=0.3
            )
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            import json as json_lib
            response_clean = response.strip()
            
            # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ
            json_start = response_clean.find('{')
            json_end = response_clean.rfind('}') + 1
            
            if json_start != -1 and json_end > json_start:
                json_str = response_clean[json_start:json_end]
                try:
                    info = json_lib.loads(json_str)
                    return info
                except:
                    pass
            
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É—é –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
        
        # –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return {
            'era': 'custom',
            'role': '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å',
            'period': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            'icon': 'üë§',
            'system_prompt': f'–¢—ã {personality_name}, –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏—Ö —ç–ø–æ—Ö. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ –∏ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ.'
        }
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ª–∏—á–Ω–æ—Å—Ç–∏: {e}")
        import traceback
        traceback.print_exc()
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        return {
            'era': 'custom',
            'role': '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å',
            'period': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
            'icon': 'üë§',
            'system_prompt': f'–¢—ã {personality_name}, –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å. –¢—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏—Ö —ç–ø–æ—Ö. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å–æ–±—ã—Ç–∏—è—Ö –ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ - –≤—ã—Ä–∞–∂–∞–π –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏–µ. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ –∏ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ.'
        }

@app.route('/api/translate_name', methods=['POST'])
def translate_name_api():
    """API –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"""
    data = request.json
    name = data.get('name', '')
    lang = get_lang()
    
    translated_name = translate_name(name, lang)
    return jsonify({'translated_name': translated_name})

@app.route('/api/create_custom_personality', methods=['POST'])
def create_custom_personality_api():
    if 'user_id' not in session:
        return jsonify({'error': 'Not authenticated'}), 401
    
    # –ü—Ä–µ–º–∏—É–º –±–æ–ª—å—à–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã
    
    data = request.json
    personality_name = data.get('name')
    
    if not personality_name or not personality_name.strip():
        return jsonify({'error': '–ò–º—è –ª–∏—á–Ω–æ—Å—Ç–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º'}), 400
    
    personality_name = personality_name.strip()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ –ø—Ä–æ–±–µ–ª–æ–≤)
    cursor = db_conn.cursor()
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–º—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É)
    normalized_name = ' '.join(personality_name.lower().split())
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    cursor.execute('SELECT id, name FROM personalities WHERE LOWER(TRIM(name)) = ?', (normalized_name,))
    existing = cursor.fetchone()
    
    if existing:
        existing_id, existing_name = existing
        return jsonify({'error': f'–õ–∏—á–Ω–æ—Å—Ç—å "{existing_name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'}), 400
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ö–æ–∂–∏–µ –∏–º–µ–Ω–∞ (–µ—Å–ª–∏ –∏–º—è –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–æ–º –∏–ª–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏)
    cursor.execute('SELECT id, name FROM personalities')
    all_personalities = cursor.fetchall()
    
    for pid, pname in all_personalities:
        normalized_existing = ' '.join(pname.lower().split())
        if normalized_existing == normalized_name:
            return jsonify({'error': f'–õ–∏—á–Ω–æ—Å—Ç—å "{pname}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ø–æ—Ö–æ–∂–µ–µ –∏–º—è)'}), 400
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—á–Ω–æ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
    current_lang = get_lang()  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫ –∏–∑ —Å–µ—Å—Å–∏–∏
    print(f"ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—á–Ω–æ—Å—Ç–∏ '{personality_name}' —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–∞ —è–∑—ã–∫–µ '{current_lang}'...")
    personality_info = asyncio.run(generate_personality_info(personality_name, current_lang))
    
    # –°–æ–∑–¥–∞–µ–º –ª–∏—á–Ω–æ—Å—Ç—å —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
    cursor.execute('''
        INSERT INTO personalities (name, era, role, period, icon, system_prompt, is_active)
        VALUES (?, ?, ?, ?, ?, ?, 1)
    ''', (
        personality_name,
        personality_info.get('era', 'custom'),
        personality_info.get('role', '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å'),
        personality_info.get('period', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
        personality_info.get('icon', 'üë§'),
        personality_info.get('system_prompt', f'–¢—ã {personality_name}, –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å. –ü–æ–º–Ω–∏: —Ç—ã –∑–Ω–∞–µ—à—å —Ç–æ–ª—å–∫–æ –æ —Å–æ–±—ã—Ç–∏—è—Ö —Å–≤–æ–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏—Ö —ç–ø–æ—Ö, –Ω–∏—á–µ–≥–æ –æ –±—É–¥—É—â–µ–º. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ –∏ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ.')
    ))
    
    db_conn.commit()
    
    print(f"‚úÖ –õ–∏—á–Ω–æ—Å—Ç—å '{personality_name}' —Å–æ–∑–¥–∞–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π: {personality_info}")
    
    return jsonify({
        'success': True,
        'personality': {
            'name': personality_name,
            'era': personality_info.get('era', 'custom'),
            'role': personality_info.get('role', '–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å'),
            'period': personality_info.get('period', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
            'icon': personality_info.get('icon', 'üë§'),
            'system_prompt': personality_info.get('system_prompt', f'–¢—ã {personality_name}, –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –ª–∏—á–Ω–æ—Å—Ç—å. –ì–æ–≤–æ—Ä–∏ –º—É–¥—Ä–æ –∏ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ.')
        }
    })

# ========== –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê –° NGROK ==========
def start_server_with_ngrok():
    """–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º ngrok"""
    print("=" * 60)
    print("üé≠ –ó–ê–ü–£–°–ö –ò–°–¢–û–†–ò–ß–ï–°–ö–û–ì–û –ß–ê–¢-–ë–û–¢–ê –° NGROK")
    print("=" * 60)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã
    initialize_personalities()
    
    # –ü–æ—Ä—Ç –¥–ª—è Flask
    PORT = int(os.getenv("PORT", 5000))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º ngrok –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ (—á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫)
    def start_ngrok():
        time.sleep(2)  # –î–∞–µ–º Flask –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
        ngrok_url = setup_ngrok(PORT)
        if ngrok_url:
            print("\n" + "=" * 60)
            print("üéâ –°–ï–†–í–ï–† –ó–ê–ü–£–©–ï–ù –£–°–ü–ï–®–ù–û!")
            print("=" * 60)
            print(f"üåê –õ–æ–∫–∞–ª—å–Ω—ã–π URL: http://localhost:{PORT}")
            print(f"üåê –ü—É–±–ª–∏—á–Ω—ã–π URL: {ngrok_url}")
            try:
                print(f"üîó HTTPS URL: {ngrok_url.replace('http://', 'https://')}")
            except Exception:
                pass
            print("=" * 60)
            print("\nüì± –û—Ç–∫—Ä–æ–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π URL –Ω–∞ –ª—é–±–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ!")
            print("=" * 60)
        else:
            print("\n" + "=" * 60)
            print("üéâ –°–ï–†–í–ï–† –ó–ê–ü–£–©–ï–ù –£–°–ü–ï–®–ù–û (–õ–û–ö–ê–õ–¨–ù–û)!")
            print("=" * 60)
            print(f"üåê –õ–æ–∫–∞–ª—å–Ω—ã–π URL: http://localhost:{PORT}")
            print("‚ö†Ô∏è  Ngrok –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ")
            print("=" * 60)
            print("\nüì± –û—Ç–∫—Ä–æ–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ!")
            print("=" * 60)
    
    ngrok_thread = threading.Thread(target=start_ngrok, daemon=True)
    ngrok_thread.start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask
    print(f"\nüöÄ –ó–∞–ø—É—Å–∫–∞—é Flask —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É {PORT}...")
    app.run(debug=False, host='0.0.0.0', port=PORT, threaded=True)

# ========== –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ó–ê–ü–£–°–ö –ë–ï–ó NGROK ==========
def start_server_without_ngrok():
    """–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –±–µ–∑ ngrok"""
    print("=" * 60)
    print("üé≠ –ó–ê–ü–£–°–ö –ò–°–¢–û–†–ò–ß–ï–°–ö–û–ì–û –ß–ê–¢-–ë–û–¢–ê (–õ–û–ö–ê–õ–¨–ù–û)")
    print("=" * 60)
    
    initialize_personalities()
    
    port = int(os.getenv("PORT", 5000))
    print(f"\nüöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: http://localhost:{port}")
    print("‚ö†Ô∏è  –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Å ngrok (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).")
    print("=" * 60)
    
    app.run(debug=True, host='0.0.0.0', port=port)

# ========== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ==========
if __name__ == '__main__':
    import argparse
    
    parser = argparse.ArgumentParser(description='–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —á–∞—Ç-–±–æ—Ç')
    parser.add_argument('--local', action='store_true', help='–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ ngrok)')
    args = parser.parse_args()
    
    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Å ngrok.
    if args.local:
        start_server_without_ngrok()
    else:
        start_server_with_ngrok()